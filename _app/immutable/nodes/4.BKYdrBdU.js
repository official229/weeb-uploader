import{f as _,a as p,c as Pe}from"../chunks/CTHEc7mS.js";import{z as dt,A as z,B as e,C as u,D as Ue,E as Ae,I as r,K as l,J as i,G as U,H as Le,aH as _e,aI as pt,u as Ce,F as Se,aJ as rt,aC as Ye,af as vt}from"../chunks/DpPdw_ub.js";import{d as Oe}from"../chunks/D_Kb6Vk8.js";import{p as Fe,b as Xe,i as Z}from"../chunks/DxCQtHkc.js";import{r as ft,a as gt,s as Qe}from"../chunks/DofntP01.js";import{s as D}from"../chunks/CI280J2U.js";import{s as xe,e as Re,i as Me,D as ht,g as mt,a as _t,t as nt,T as bt,b as xt,C as qe,p as wt,S as et,c as yt,d as St,f as Ft,h as Et,j as Nt,k as It,l as Ct,m as tt,n as zt,o as at,q as Zt,r as Dt,u as kt,Z as Tt,B as Pt,v as Gt,w as Rt,x as Mt,U as At,y as Lt,z as Ot}from"../chunks/CU0M1q1c.js";import{b as ot,A as Vt}from"../chunks/Cjq1WBUe.js";import{a as jt,r as st}from"../chunks/fpgiSszx.js";import{g as qt}from"../chunks/CY2_5vFb.js";const Ut=!0,Qa=Object.freeze(Object.defineProperty({__proto__:null,prerender:Ut},Symbol.toStringTag,{value:"Module"}));var Te=(S=>(S.SELECTING_ROOT_FOLDER="SELECTING_ROOT_FOLDER",S.SELECTING_MANGA_FOLDERS="SELECTING_MANGA_FOLDERS",S.PROCESSING_MANGA="PROCESSING_MANGA",S))(Te||{}),be=(S=>(S.PENDING="PENDING",S.PROCESSING="PROCESSING",S.COMPLETED="COMPLETED",S.ERROR="ERROR",S))(be||{});class Wt{#e=z(null);get rootFolderFiles(){return e(this.#e)}set rootFolderFiles(s){u(this.#e,s,!0)}#t=z(Ue([]));get zipFiles(){return e(this.#t)}set zipFiles(s){u(this.#t,s,!0)}#a=z(Ue([]));get selectedZipFiles(){return e(this.#a)}set selectedZipFiles(s){u(this.#a,s,!0)}#s=z(-1);get currentZipIndex(){return e(this.#s)}set currentZipIndex(s){u(this.#s,s,!0)}#i=z("SELECTING_ROOT_FOLDER");get workflowStep(){return e(this.#i)}set workflowStep(s){u(this.#i,s,!0)}get currentZip(){return this.currentZipIndex<0||this.currentZipIndex>=this.zipFiles.length?null:this.zipFiles[this.currentZipIndex]}get unprocessedZips(){return this.zipFiles.filter(s=>this.selectedZipFiles.includes(s.file)&&s.status==="PENDING")}get nextZip(){const s=this.unprocessedZips;return s.length===0?null:s[0]}setZipStatus(s,a){const t=this.zipFiles.find(I=>I.file===s);t&&(t.status=a)}moveToNextZip(){const s=this.nextZip;if(!s)return!1;const a=this.zipFiles.findIndex(t=>t.file===s.file);return a>=0?(this.currentZipIndex=a,!0):!1}get zipFilesByMangaFolder(){const s=new Map;for(const a of this.zipFiles)s.has(a.mangaFolderName)||s.set(a.mangaFolderName,[]),s.get(a.mangaFolderName).push(a);return s}reset(){this.rootFolderFiles=null,this.zipFiles=[],this.selectedZipFiles=[],this.currentZipIndex=-1,this.workflowStep="SELECTING_ROOT_FOLDER"}}const Bt=dt();var $t=_('<div class="uno-4maolu"><div class="uno-senp7v"></div> <p class="uno-l6h9uf">Scanning folder structure...</p></div>'),Ht=_('<div class="uno-laclbo"><p class="uno-dl0t86"> </p></div>'),Jt=_('<div class="uno-tm086o"><button><h1 class="uno-brv6u2">Select Root Folder</h1> <p class="uno-l6h9uf">Select the folder containing manga subfolders with .zip files</p> <input class="uno-qya2ty" type="file"/></button> <!> <!></div>');function Kt(S,s){Ae(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,""),I=z(null),c=z(!1);async function V(k){u(c,!0);const B=k.target,K=Array.from(B.files??[]),G=[];for(const R of K){const T=(R.webkitRelativePath||R.name).split("/").filter(Boolean);if(T.length>=2){const O=T[0],f=T[0],y=R.name.split(".").pop()?.toLowerCase();(y==="zip"||y==="cbz")&&G.push({file:R,mangaFolderName:O,mangaFolderPath:f})}}a().rootFolderFiles=K,a().zipFiles=G.map(R=>({...R,status:be.PENDING})),u(c,!1),s.onDone()}function C(k){e(I)?.click()}var q=Jt(),F=r(q);F.__click=C;var E=l(r(F),4);E.webkitdirectory=!0,E.multiple=!0,E.__change=V,Xe(E,k=>u(I,k),()=>e(I)),i(F);var L=l(F,2);{var re=k=>{var B=$t();p(k,B)};Z(L,k=>{e(c)&&k(re)})}var se=l(L,2);{var W=k=>{var B=Ht(),K=r(B),G=r(K);i(K),i(B),U(()=>D(G,`Found ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"}`)),p(k,B)};Z(se,k=>{a().zipFiles.length>0&&k(W)})}i(q),U(()=>{xe(F,1,`uno-a4tqjo ${t()??""}`),F.disabled=e(c)}),p(S,q),Le()}Oe(["click","change"]);var Yt=_('<button type="button"><div class="uno-bpywdh"><p class="uno-98yf80"> </p> <p class="uno-42pivu"> </p></div> <input type="checkbox" class="uno-5onsv4"/></button>'),Xt=_('<div class="uno-o40niy"><div class="uno-iuhcpm"><h3 class="uno-0lb4rh"> </h3> <button type="button" class="uno-phh4jd"> </button></div> <div class="uno-fb55wk"></div></div>'),Qt=_('<div><div class="uno-iuhcpm"><h2 class="uno-iyer7g">Select Zip Files to Process</h2> <button type="button" class="uno-f45w65"> </button></div> <p class="uno-ok9xip"> </p> <div class="uno-yjimjk"></div> <button type="button" class="uno-3s4o5e"> </button></div>');function ea(S,s){Ae(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,"");function I(G){a().selectedZipFiles.indexOf(G)>=0?a().selectedZipFiles=a().selectedZipFiles.filter(b=>b!==G):a().selectedZipFiles=[...a().selectedZipFiles,G]}function c(G){const R=Array.from(a().zipFilesByMangaFolder.get(G)??[]);if(R.every(T=>a().selectedZipFiles.includes(T.file)))a().selectedZipFiles=a().selectedZipFiles.filter(T=>!R.some(O=>O.file===T));else{const T=R.map(O=>O.file).filter(O=>!a().selectedZipFiles.includes(O));a().selectedZipFiles=[...a().selectedZipFiles,...T]}}function V(){a().selectedZipFiles.length===a().zipFiles.length?a().selectedZipFiles=[]:a().selectedZipFiles=a().zipFiles.map(G=>G.file)}const C=_e(()=>a().zipFiles.length>0&&a().selectedZipFiles.length===a().zipFiles.length),q=_e(()=>a().zipFilesByMangaFolder);var F=Qt(),E=r(F),L=l(r(E),2);L.__click=V;var re=r(L,!0);i(L),i(E);var se=l(E,2),W=r(se);i(se);var k=l(se,2);Re(k,21,()=>Array.from(e(q).entries()),Me,(G,R)=>{var b=_e(()=>pt(e(R),2));let T=()=>e(b)[0],O=()=>e(b)[1];var f=Xt(),y=r(f),M=r(y),Y=r(M,!0);i(M);var ie=l(M,2);ie.__click=()=>c(T());var oe=r(ie);i(ie),i(y);var ne=l(y,2);Re(ne,21,O,Me,(ee,le)=>{const ue=_e(()=>a().selectedZipFiles.includes(e(le).file));var o=Yt();o.__click=()=>I(e(le).file);var v=r(o),h=r(v),d=r(h,!0);i(h);var x=l(h,2),m=r(x);i(x),i(v);var w=l(v,2);ft(w),i(o),U(N=>{xe(o,1,`uno-ik4adi ${e(ue)?"uno-1k75dk":""}`),D(d,e(le).file.name),D(m,`Size: ${N??""} MB`),gt(w,e(ue))},[()=>(e(le).file.size/(1024*1024)).toFixed(2)]),p(ee,o)}),i(ne),i(f),U(ee=>{D(Y,T()),D(oe,`${ee??""} (${O().length??""})`)},[()=>O().every(ee=>a().selectedZipFiles.includes(ee.file))?"Deselect All":"Select All"]),p(G,f)}),i(k);var B=l(k,2);B.__click=function(...G){s.onDone?.apply(this,G)};var K=r(B);i(B),i(F),U(()=>{xe(F,1,`uno-grwdkw ${t()??""}`),D(re,e(C)?"Deselect All":"Select All"),D(W,`${a().selectedZipFiles.length??""} of ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"} selected`),B.disabled=a().selectedZipFiles.length===0,D(K,`Continue to Processing (${a().selectedZipFiles.length??""} selected)`)}),p(S,F),Le()}Oe(["click"]);var ta=_('<p class="uno-a54tpo"> </p>'),aa=_('<div class="uno-cqccui"><p class="uno-nsysfu"> </p> <span> </span></div> <!>',1),sa=_('<p class="uno-b7m48p">No zip file selected</p>'),ia=_('<button type="button" class="uno-qm31yq"> </button>'),ra=_('<p class="uno-b7m48p">No more zip files to process</p>'),na=_('<p class="uno-b7m48p">All zip files have been processed</p>'),oa=_('<div><div class="uno-2db0z0"><h3 class="uno-py45hl">Current Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Next Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Unprocessed Zip Files</h3> <!></div></div>');function la(S,s){Ae(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,"");function I(){if(a().moveToNextZip()){const f=a().currentZip;f&&s.onZipSelected(f.file)}}function c(f){const y=a().zipFiles.find(M=>M.file.name===f);if(y){const M=a().zipFiles.findIndex(Y=>Y.file===y.file);M>=0&&(a().currentZipIndex=M,s.onZipSelected(y.file))}}const V=_e(()=>a().currentZip?.file.name??null),C=_e(()=>a().unprocessedZips.map(f=>f.file.name)),q=_e(()=>a().nextZip?.file.name??null);let F=z(null);Ce(()=>{u(F,a().currentZip?.file.name??null,!0)}),Ce(()=>{const f=e(F);if(f){const y=a().currentZip?.file.name??null;f!==y&&c(f)}});var E=oa(),L=r(E),re=l(r(L),2);{var se=f=>{var y=aa(),M=Se(y),Y=r(M),ie=r(Y,!0);i(Y);var oe=l(Y,2),ne=r(oe,!0);i(oe),i(M);var ee=l(M,2);{var le=ue=>{var o=ta(),v=r(o);i(o),U(()=>D(v,`Manga Folder: ${a().currentZip.mangaFolderName??""}`)),p(ue,o)};Z(ee,ue=>{a().currentZip&&ue(le)})}U(()=>{D(ie,e(V)),xe(oe,1,`uno-ielryd ${a().currentZip?.status===be.PROCESSING?"uno-kxa2ln":a().currentZip?.status===be.COMPLETED?"uno-b1425w":a().currentZip?.status===be.ERROR?"uno-isu16c":"uno-jwlzg2"}`),D(ne,a().currentZip?.status??"UNKNOWN")}),p(f,y)},W=f=>{var y=sa();p(f,y)};Z(re,f=>{e(V)?f(se):f(W,!1)})}i(L);var k=l(L,2),B=l(r(k),2);{var K=f=>{var y=ia();y.__click=I;var M=r(y);i(y),U(()=>D(M,`Process: ${e(q)??""}`)),p(f,y)},G=f=>{var y=ra();p(f,y)};Z(B,f=>{e(q)?f(K):f(G,!1)})}i(k);var R=l(k,2),b=l(r(R),2);{var T=f=>{ht(f,{get items(){return e(C)},class:"uno-qbg2l1",get selectedItem(){return e(F)},set selectedItem(y){u(F,y,!0)}})},O=f=>{var y=na();p(f,y)};Z(b,f=>{e(C).length>0?f(T):f(O,!1)})}i(R),i(E),U(()=>xe(E,1,`uno-s0eao9 ${t()??""}`)),p(S,E),Le()}Oe(["click"]);function ua(S){const s=mt(S,0);return _t(S,s,0,[])}function ca(S,s="v(\\d+)"){const a=new RegExp(s,"i"),t=S.match(a);return t&&t[1]?t[1].replace(/^0+/,"")||"0":null}function da(S,s="c(\\d+(?:\\.\\d+){0,2})"){const a=new RegExp(s,"i"),t=S.match(a);if(t&&t[1]){const I=t[1];if(I.includes(".")){const c=I.split(".");return[c[0].replace(/^0+/,"")||"0",...c.slice(1)].join(".")}else return I.replace(/^0+/,"")||"0"}return null}function pa(S){const s=/MD-(\d+)/i,a=S.match(s);return a?a[1]:null}var va=_('<span class="uno-lzl9l3 svelte-m4i47p">Removed</span>'),fa=_('<button type="button" class="uno-5of0xd svelte-m4i47p" title="Edit volume and chapter" aria-label="Edit volume and chapter"><div class="uno-smkhzc svelte-m4i47p"></div></button>'),ga=_('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-m5mbjf svelte-m4i47p"></div> <span class="svelte-m4i47p">Restore</span></div>'),ha=_('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-9z7ooq svelte-m4i47p"></div> <span class="svelte-m4i47p">Remove</span></div>'),ma=_('<span class="uno-2et217 svelte-m4i47p"> </span>'),_a=_('<span class="uno-38wzts svelte-m4i47p"> </span>'),ba=_('<div class="uno-zh7qvs svelte-m4i47p"></div>'),xa=_('<span class="uno-2et217 svelte-m4i47p">No groups assigned</span>'),wa=_('<div class="uno-58lieu svelte-m4i47p">Loading combinations...</div>'),ya=_('<div class="uno-58lieu svelte-m4i47p">No volume/chapter combinations available</div>'),Sa=_('<button type="button"><div class="uno-l6o6ga svelte-m4i47p"><span class="svelte-m4i47p"> </span></div></button>'),Fa=_('<div class="uno-iqadiw svelte-m4i47p" role="presentation"><div class="uno-k7cjbm svelte-m4i47p"><!></div></div>'),Ea=_('<div><div class="uno-rzokcw svelte-m4i47p"><div class="uno-n4d6p5 svelte-m4i47p"><span class="uno-upv063 svelte-m4i47p"> </span> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Vol:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Ch:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Pages:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div></div> <button type="button"><!></button></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Title:</span> <div class="uno-aqzn48 svelte-m4i47p"><!> <!></div></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Groups:</span> <!></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Path:</span> <span class="uno-nggqeg svelte-m4i47p"> </span></div></div> <!>',1);function Na(S,s){Ae(s,!0);const a=rt(nt);if(!a)throw new Error("GuidedChapterEditor must be used within a component that provides TargetingState context");let t=Fe(s,"chapter",7),I=Fe(s,"class",3,""),c=z(!1),V=z(Ue([])),C=z(!1),q=z(null),F=z(null),E=z(null),L=z(null);function re(){t().isDeleted=!t().isDeleted}async function se(){if(!e(c)){e(q)&&u(L,e(q).getBoundingClientRect(),!0),u(c,!0),u(C,!0);try{const n=t().associatedSeries?.seriesId;if(!n){console.warn("No series ID available for chapter"),u(c,!1);return}await qe.load(),u(V,await qe.getUniqueVolumeChapterCombinations(n),!0)}catch(n){console.error("Failed to load volume/chapter combinations:",n)}finally{u(C,!1)}}}function W(){u(c,!1),u(E,null),u(L,null)}function k(n){t().manuallyEditedFields.has("volume")||(t().originalFieldValues.has("volume")||t().originalFieldValues.set("volume",t().chapterVolume),t().manuallyEditedFields.add("volume")),t().manuallyEditedFields.has("chapter")||(t().originalFieldValues.has("chapter")||t().originalFieldValues.set("chapter",t().chapterNumber),t().manuallyEditedFields.add("chapter")),t().manuallyEditedFields.has("title")||(t().originalFieldValues.has("title")||t().originalFieldValues.set("title",t().chapterTitle),t().manuallyEditedFields.add("title")),t().chapterVolume=n.volume||null,t().chapterNumber=n.chapter||null,t().chapterTitle=n.title||null,W()}function B(n){const g=n.volume||"N/A",A=n.chapter||"N/A",P=n.title?` - ${n.title}`:"";return`Vol ${g}, Ch ${A}${P}`}function K(){if(!e(L))return;const n=e(L),g=window.innerHeight,A=window.innerWidth,P=4,de=256;let pe=de;if(e(F)){const De=e(F).getBoundingClientRect().height;pe=Math.min(De,de)}const Q=g-n.bottom-P,he=n.top-P,Ze=Q<de&&he>Q;let ve;Ze?(ve=n.top-pe-P,ve<P&&(ve=P)):(ve=n.bottom+P,ve+pe>g&&(ve=Math.max(P,g-pe-P)));let J=n.left;const we=320,me=Math.min(400,A-P*2),ye=Math.max(we,Math.min(me,n.width));J+ye>A-P&&(J=A-ye-P),J<P&&(J=P),u(E,{top:ve,left:J,width:ye},!0)}Ce(()=>{if(e(c)){if(!e(L)){u(E,null);return}requestAnimationFrame(()=>{requestAnimationFrame(()=>{K()})});const n=()=>K(),g=P=>{const de=P.target;e(F)&&!e(F).contains(de)&&e(q)&&!e(q).contains(de)&&W()},A=setTimeout(()=>{window.addEventListener("resize",n),document.addEventListener("click",g,!0)},10);return()=>{clearTimeout(A),window.removeEventListener("resize",n),document.removeEventListener("click",g,!0)}}else u(E,null)}),Ce(()=>{e(c)&&e(F)&&requestAnimationFrame(()=>{K()})});var G=Ea(),R=Se(G),b=r(R),T=r(b),O=r(T),f=r(O);i(O);var y=l(O,2);{var M=n=>{var g=va();p(n,g)};Z(y,n=>{t().isDeleted&&n(M)})}var Y=l(y,2),ie=l(r(Y),2),oe=r(ie,!0);i(ie),i(Y);var ne=l(Y,2),ee=l(r(ne),2),le=r(ee,!0);i(ee),i(ne);var ue=l(ne,2);{var o=n=>{var g=fa();g.__click=A=>{A.stopPropagation(),se()},Xe(g,A=>u(q,A),()=>e(q)),p(n,g)};Z(ue,n=>{t().associatedSeries?.seriesId&&n(o)})}var v=l(ue,2),h=l(r(v),2),d=r(h,!0);i(h),i(v),i(T);var x=l(T,2);x.__click=re;var m=r(x);{var w=n=>{var g=ga();p(n,g)},N=n=>{var g=ha();p(n,g)};Z(m,n=>{t().isDeleted?n(w):n(N,!1)})}i(x),i(b);var j=l(b,2),X=l(r(j),2),$=r(X);bt($,{textClass:"text-sm text-app font-medium",fieldName:"title",get chapter(){return t()},get value(){return t().chapterTitle},set value(n){t().chapterTitle=n}});var te=l($,2);{var ce=n=>{var g=ma(),A=r(g);i(g),U(()=>D(A,`(${(t().originalFolderPath||"Untitled")??""})`)),p(n,g)};Z(te,n=>{t().chapterTitle||n(ce)})}i(X),i(j);var H=l(j,2),ae=l(r(H),2);{var ge=n=>{var g=ba();Re(g,21,()=>t().associatedGroup.groupIds,Me,(A,P)=>{const de=_e(()=>a.availableScanGroups.find(he=>he.groupId===e(P)));var pe=_a(),Q=r(pe,!0);i(pe),U(()=>D(Q,e(de)?.groupName??e(P))),p(A,pe)}),i(g),p(n,g)},Ee=n=>{var g=xa();p(n,g)};Z(ae,n=>{t().associatedGroup.groupIds&&t().associatedGroup.groupIds.length>0?n(ge):n(Ee,!1)})}i(H);var ze=l(H,2),Ne=l(r(ze),2),We=r(Ne,!0);i(Ne),i(ze),i(R);var Ge=l(R,2);{var Je=n=>{var g=Fa();g.__click=Q=>Q.stopPropagation();var A=r(g),P=r(A);{var de=Q=>{var he=wa();p(Q,he)},pe=Q=>{var he=Pe(),Ze=Se(he);{var ve=we=>{var me=ya();p(we,me)},J=we=>{var me=Pe(),ye=Se(me);Re(ye,17,()=>e(V),Me,(De,Ie)=>{var ke=Sa();ke.__click=()=>k(e(Ie));var Be=r(ke),$e=r(Be),He=r($e,!0);i($e),i(Be),i(ke),U(Ke=>{xe(ke,1,`uno-ss9yjz ${t().chapterVolume===e(Ie).volume&&t().chapterNumber===e(Ie).chapter?"uno-eokg3r":""}`,"svelte-m4i47p"),D(He,Ke)},[()=>B(e(Ie))]),p(De,ke)}),p(we,me)};Z(Ze,we=>{e(V).length===0?we(ve):we(J,!1)},!0)}p(Q,he)};Z(P,Q=>{e(C)?Q(de):Q(pe,!1)})}i(A),i(g),Xe(g,Q=>u(F,Q),()=>e(F)),U(()=>xt(g,`top: ${e(E).top??""}px; left: ${e(E).left??""}px; width: ${e(E).width??""}px;`)),p(n,g)};Z(Ge,n=>{e(c)&&e(E)&&n(Je)})}U(()=>{xe(R,1,`uno-3rf4hu ${t().isDeleted?"uno-d3zfvr":""} ${I()??""}`,"svelte-m4i47p"),D(f,`#${s.index+1}`),D(oe,t().chapterVolume??"N/A"),D(le,t().chapterNumber??"N/A"),D(d,t().pages.length),xe(x,1,`uno-lto8ne ${t().isDeleted?"uno-ld06wt":"uno-far8pd"}`,"svelte-m4i47p"),Qe(x,"title",t().isDeleted?"Restore chapter":"Mark as removed"),D(We,t().originalFolderPath)}),p(S,G),Le()}Oe(["click"]);class Ia{#e=z(null);get legacyToWeebdexMap(){return e(this.#e)}set legacyToWeebdexMap(s){u(this.#e,s,!0)}#t=z(null);get weebdexToLegacyMap(){return e(this.#t)}set weebdexToLegacyMap(s){u(this.#t,s,!0)}#a=z(!1);get isLoading(){return e(this.#a)}set isLoading(s){u(this.#a,s,!0)}#s=z(null);get loadError(){return e(this.#s)}set loadError(s){u(this.#s,s,!0)}loadPromise=null;async load(){if(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)return;if(this.loadPromise)return this.loadPromise;this.isLoading=!0,this.loadError=null;let s,a;this.loadPromise=new Promise((t,I)=>{s=t,a=I});try{const t=jt("/weebdex_lookup.csv"),I=await fetch(t);if(!I.ok)throw new Error(`Failed to fetch CSV: ${I.status} ${I.statusText}`);const c=await I.text(),{legacyToWeebdex:V,weebdexToLegacy:C}=this.parseCSV(c);this.legacyToWeebdexMap=V,this.weebdexToLegacyMap=C,s()}catch(t){this.loadError=t instanceof Error?t:new Error("Unknown error loading CSV"),a(this.loadError)}finally{this.isLoading=!1}return this.loadPromise}async ensureLoaded(){if(!(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)){if(this.loadPromise){await this.loadPromise;return}await this.load()}}parseCSV(s){const a=wt(s,{columns:!0,skip_empty_lines:!0,trim:!0}),t=new et,I=new et;for(const c of a){const V=c.weebdex_id?.trim()||"",C=c.legacy_id?.trim()||"";V&&C&&(t.set(C,V),I.set(V,C))}return{legacyToWeebdex:t,weebdexToLegacy:I}}async getWeebdexIdFromLegacyId(s){return await this.ensureLoaded(),this.legacyToWeebdexMap===null?null:this.legacyToWeebdexMap.get(s)||null}}const it=new Ia;var Ca=_('<p class="uno-8520et"> </p>'),za=_('<div class="uno-vsugad"><div class="uno-pj4440"></div> <p class="uno-hw2z5w"> </p> <!></div>'),Za=_('<div class="uno-f2o4wl"><p class="uno-hw2z5w">Loading chapter dump and applying groups/titles...</p></div>'),Da=_('<span class="uno-czmb1a">Removed</span>'),ka=_('<div class="uno-2umhxz"></div>'),Ta=_('<div class="uno-kp2ftc"></div>'),Pa=_('<div><div class="uno-py2y93"><div class="uno-nxlaaf"><p class="uno-39vbxq"> </p> <!></div> <p class="uno-dsgwse"> </p></div> <button type="button"><!></button></div>'),Ga=_(`<div class="uno-bi16xf"><div class="uno-nnnwwl"><div class="uno-djaa0e"><p class="uno-apr5a0"> </p> <p class="uno-lp9tww">The following chapters already exist on WeebDex with matching groups. You can mark
								them as removed to skip uploading.</p></div> <button type="button" class="uno-3jkjwc" title="Mark all duplicate chapters as removed">Removed duplicate chapters</button></div> <div class="uno-56cpuz"></div></div>`),Ra=_('<div class="uno-hemz07"><div class="uno-ns83sq"><p class="uno-0zsd1s"> </p></div> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Series Selection (Required)</h3> <!> <!> <!></div> <!> <!> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Detected Chapters</h3> <div class="uno-xqlxhl"></div></div> <button type="button" class="uno-d93lfx"> </button></div>'),Ma=_('<div class="uno-6nb6x4"><p class="uno-dillda">✓ Upload completed successfully!</p></div>'),Aa=_('<div><h2 class="uno-67n1yz"> </h2> <!></div>');function La(S,s){Ae(s,!0),yt({useWebWorkers:!1});let a=Fe(s,"class",3,"");const t=new St;Ye(nt,t);const I=rt(ot);if(!I)throw new Error("MangaProcessor must be used within a component that provides ApiAuthContext");let c=z("loading"),V=z(null),C=z(Ue([])),q=z(!1),F=z(!1),E=z(null),L=z(!1),re=z(null),se=z(!1),W=z(Ue([]));const k=["jpg","jpeg","png","gif","webp","cbz","zip","xml"];Ce(()=>{s.zipFile&&(u(L,!1),u(re,null),u(W,[],!0),G())});async function B(o){const v=o.name.split(".").pop()?.toLowerCase();if(!(v==="cbz")&&!(v==="zip"))throw new Error(`Unsupported archive format: ${v}`);console.log(`Extracting ${v} file:`,o.name),u(E,o.name,!0);const x=new Tt(new Pt(o)),m=await x.getEntries(),w=[],N=o.name.replace(/\.(cbz|zip)$/i,""),j=o.webkitRelativePath||o.name;for(const X of m){if(!X.filename||X.directory)continue;const $=X.filename.split(".").pop()?.toLowerCase();if(!$||!k.includes($))continue;const te=new TransformStream,ce=new Response(te.readable).blob();await X.getData(te.writable);let H=await ce;if(!H.type){const Ne=K($);H=new Blob([H],{type:Ne})}const ae=X.filename,ge=ae.split("/").pop()??ae,Ee=j.includes("/")?`${j.split("/").slice(0,-1).join("/")}/${N}/${ae}`:`${N}/${ae}`,ze=new File([H],ge,{type:H.type});Object.defineProperty(ze,"webkitRelativePath",{value:Ee,writable:!1,enumerable:!0,configurable:!0}),w.push(ze)}return await x.close(),u(E,null),w}function K(o){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp"}[o]||"application/octet-stream"}async function G(){u(c,"loading"),t.reset();const o=pa(s.zipFile.name);if(o)try{await it.load();const d=await it.getWeebdexIdFromLegacyId(o);d?(t.seriesId=d,console.log(`Auto-detected series ID from MD-####: ${o} -> ${d}`)):console.log(`No WeebDex ID found for MangaDex ID: ${o}`)}catch(d){console.warn(`Failed to lookup WeebDex ID for MangaDex ID ${o}:`,d)}u(c,"extracting");let v=[];try{v=await B(s.zipFile)}catch(d){console.error(`Error extracting ${s.zipFile.name}:`,d),s.guidedState.setZipStatus(s.zipFile,be.ERROR);return}u(V,Ft(v),!0);const h=ua(e(V));u(c,"extracting"),u(C,await Promise.all(h.map(async d=>{const x=ca(d.name),m=da(d.name),w=d.files.filter(N=>N.type===Et.CHAPTER_PAGE).map((N,j)=>new Nt(N.file.name,j,N.file,It.NOT_STARTED,0,null,null,!1,N.type));return new Ct(d.path,d.name,x,m,new tt,new zt,w,at.NOT_STARTED,0,null,null,d,!1,"en")})),!0),e(C).sort((d,x)=>{if(d.chapterVolume&&x.chapterVolume){const m=String(d.chapterVolume).localeCompare(String(x.chapterVolume),void 0,{numeric:!0,sensitivity:"base"});if(m!==0)return m}else{if(d.chapterVolume)return-1;if(x.chapterVolume)return 1}return d.chapterNumber&&x.chapterNumber?String(d.chapterNumber).localeCompare(String(x.chapterNumber),void 0,{numeric:!0,sensitivity:"base"}):d.chapterNumber?-1:x.chapterNumber?1:0}),t.chapterStates=e(C),u(c,"ready")}Ce(()=>{t.seriesId!==null&&t.chapterStates.forEach(o=>{o.associatedSeries||(o.associatedSeries=new tt),o.associatedSeries.seriesId=t.seriesId??""})}),Ce(()=>{t.seriesId&&e(c)==="ready"&&(!e(L)||t.seriesId!==e(re))&&(u(L,!0),u(re,t.seriesId,!0),u(c,"series_lookup"),R())});async function R(){if(t.seriesId)try{await qe.load();const o=await qe.getAllGroupNames(t.seriesId);if(o.length===0){console.warn("No groups found in chapter dump");return}const v=[];for(const h of o)try{const d=await Zt(h);if(d.data){const x=d.data.find(m=>m.name===h);if(x){const m=new Dt;m.groupId=x.id,m.groupName=x.name,v.push(m)}}}catch(d){console.warn(`Failed to lookup group "${h}":`,d)}t.availableScanGroups=v,await b(),await T(),await O(),u(c,"ready")}catch(o){console.error("Error loading chapter dump:",o),u(c,"ready")}}async function b(){for(const o of t.chapterStates){if(!o.originalFolderPath)continue;const v=t.availableScanGroups.filter(h=>o.originalFolderPath?.includes(h.groupName)??!1);if(v.length>0){const h=o.associatedGroup.groupIds??[],d=new Set(h);for(const x of v)d.has(x.groupId)||d.add(x.groupId);o.associatedGroup.groupIds=Array.from(d)}}}async function T(){if(!t.seriesId)return;const o=new Map;for(const v of t.availableScanGroups)o.set(v.groupId,v.groupName);for(const v of t.chapterStates){const h=v.associatedGroup.groupIds??[];if(h.length===0)continue;const d=h.map(w=>o.get(w)).filter(w=>w!==void 0);if(d.length===0)continue;const x=await qe.getChapterInfo(t.seriesId,v.chapterVolume,v.chapterNumber);if(!x)continue;d.some(w=>x.groupNames.includes(w))&&(v.chapterTitle=x.title)}}async function O(){if(t.seriesId)try{const o=await kt(t.seriesId),v=[],h=new Map;for(const m of o.chapters){const w=m.volume||"none",N=m.chapter,j=`${w}:${N}`;h.set(j,m)}const d=m=>{const w=new Set;if(o.groups)for(const N of m){const j=o.groups[N];j&&w.add(j.id)}return w},x=(m,w)=>{if(m.size!==w.size)return!1;for(const N of m)if(!w.has(N))return!1;return!0};for(const m of t.chapterStates){const w=m.chapterVolume||"none",N=m.chapterNumber;if(!N)continue;const j=`${w}:${N}`,X=h.get(j);if(X&&X.entries&&Object.keys(X.entries).length>0){const $=new Set(m.associatedGroup.groupIds??[]);if($.size===0)continue;let te=null;for(const ce of Object.values(X.entries)){const H=d(ce.groups);if(x($,H)){te=ce;break}}if(te){const ce=d(te.groups),H=[];for(const ae of ce){const ge=o.groups?.find(Ee=>Ee.id===ae);ge?H.push(`${ge.name} (${ge.id})`):H.push(`Unknown Group (${ae})`)}v.push({chapter:m,existingGroups:H.length>0?H:["Unknown groups"]})}}}u(W,v,!0)}catch(o){console.error("Error checking for duplicates:",o),u(W,[],!0)}}function f(){e(se)||(u(se,!0),u(q,!1),u(c,"completed"),s.guidedState.setZipStatus(s.zipFile,be.COMPLETED),s.onProcessingComplete())}function y(){if(!I.apiToken){alert("Please set up API authentication first");return}if(!t.seriesId){alert("Please set a series ID first");return}if(t.chapterStates.length===0){alert("No chapters to upload");return}u(c,"uploading"),u(q,!0),u(se,!1),s.guidedState.setZipStatus(s.zipFile,be.PROCESSING)}const M=_e(()=>e(c)==="ready"||e(c)==="series_lookup"),Y=_e(()=>e(C).filter(o=>!o.isDeleted));Ce(()=>{if(e(c)==="uploading"&&e(C).length>0){const o=e(C).every(h=>h.status===at.COMPLETED||h.isDeleted),v=e(C).some(h=>!h.isDeleted);o&&v&&!e(q)&&(s.guidedState.setZipStatus(s.zipFile,be.COMPLETED),f())}});var ie=Aa(),oe=r(ie),ne=r(oe);i(oe);var ee=l(oe,2);{var le=o=>{var v=za(),h=l(r(v),2),d=r(h,!0);i(h);var x=l(h,2);{var m=w=>{var N=Ca(),j=r(N);i(N),U(()=>D(j,`Processing: ${e(E)??""}`)),p(w,N)};Z(x,w=>{e(E)&&w(m)})}i(v),U(()=>D(d,e(c)==="loading"?"Loading manga folder...":"Extracting zip files...")),p(o,v)},ue=o=>{var v=Pe(),h=Se(v);{var d=m=>{var w=Ra(),N=r(w),j=r(N),X=r(j);i(j),i(N);var $=l(N,2),te=l(r($),2);Gt(te,{});var ce=l(te,2);Rt(ce,{});var H=l(ce,2);Mt(H,{}),i($);var ae=l($,2);{var ge=n=>{var g=Za();p(n,g)};Z(ae,n=>{e(c)==="series_lookup"&&n(ge)})}var Ee=l(ae,2);{var ze=n=>{var g=Ga(),A=r(g),P=r(A),de=r(P),pe=r(de);i(de),vt(2),i(P);var Q=l(P,2);Q.__click=()=>{for(const{chapter:Ze}of e(W))Ze.isDeleted=!0},i(A);var he=l(A,2);Re(he,21,()=>e(W),Me,(Ze,ve)=>{let J=()=>e(ve).chapter,we=()=>e(ve).existingGroups;var me=Pa(),ye=r(me),De=r(ye),Ie=r(De),ke=r(Ie);i(Ie);var Be=l(Ie,2);{var $e=fe=>{var je=Da();p(fe,je)};Z(Be,fe=>{J().isDeleted&&fe($e)})}i(De);var He=l(De,2),Ke=r(He);i(He),i(ye);var Ve=l(ye,2);Ve.__click=()=>{J().isDeleted=!J().isDeleted};var lt=r(Ve);{var ut=fe=>{var je=ka();p(fe,je)},ct=fe=>{var je=Ta();p(fe,je)};Z(lt,fe=>{J().isDeleted?fe(ut):fe(ct,!1)})}i(Ve),i(me),U(fe=>{xe(me,1,`uno-ecxsrr ${J().isDeleted?"uno-1ya9ju":""}`),D(ke,`Vol. ${J().chapterVolume??"N/A"??""} Ch. ${J().chapterNumber??"N/A"??""} - ${(J().chapterTitle||J().originalFolderPath||"Untitled")??""}`),D(Ke,`Existing groups: ${fe??""}`),xe(Ve,1,`uno-v1bdur ${J().isDeleted?"uno-uigj71":"uno-8ta9ap"}`),Qe(Ve,"title",J().isDeleted?"Restore chapter":"Mark as removed")},[()=>we().join(", ")]),p(Ze,me)}),i(he),i(g),U(()=>D(pe,`⚠️ Warning: ${e(W).length??""} duplicate chapter${e(W).length===1?"":"s"} detected`)),p(n,g)};Z(Ee,n=>{e(W).length>0&&n(ze)})}var Ne=l(Ee,2),We=l(r(Ne),2);Re(We,21,()=>e(C),Me,(n,g,A)=>{Na(n,{index:A,get chapter(){return e(g)}})}),i(We),i(Ne);var Ge=l(Ne,2);Ge.__click=y;var Je=r(Ge);i(Ge),i(w),U(()=>{D(X,`Found ${e(C).length??""} chapter${e(C).length===1?"":"s"} from deepest folders`),Ge.disabled=!e(M)||!t.seriesId||e(Y).length===0,D(Je,`Start Upload (${e(Y).length??""} of ${e(C).length??""} chapters)`)}),p(m,w)},x=m=>{var w=Pe(),N=Se(w);{var j=$=>{At($,{onDone:f,get busy(){return e(F)},set busy(te){u(F,te,!0)}})},X=$=>{var te=Pe(),ce=Se(te);{var H=ae=>{var ge=Ma();p(ae,ge)};Z(ce,ae=>{e(c)==="completed"&&ae(H)},!0)}p($,te)};Z(N,$=>{e(c)==="uploading"?$(j):$(X,!1)},!0)}p(m,w)};Z(h,m=>{e(c)==="ready"||e(c)==="series_lookup"?m(d):m(x,!1)},!0)}p(o,v)};Z(ee,o=>{e(c)==="loading"||e(c)==="extracting"?o(le):o(ue,!1)})}i(ie),U(()=>{xe(ie,1,`uno-hemz07 ${a()??""}`),D(ne,`Processing: ${s.zipFile.name??""}`)}),p(S,ie),Le()}Oe(["click"]);var Oa=_('<div class="uno-j48514"><p class="uno-5v04yw">No zip file selected. Use the tabs above to select a zip file to process.</p></div>'),Va=_('<div class="uno-eeu1av"><!> <!></div>'),ja=_('<div class="uno-pb4e2u"><div class="uno-k0pcvl"><h1 class="uno-kryzyj">Guided Zip Manga Uploader</h1> <div class="uno-skt2gn"><button type="button" class="uno-q7l7gr">Simple Mode</button> <!></div></div> <a target="_blank" class="uno-6zhxse">Tutorial & Docs</a> <!> <!></div>');function es(S,s){Ae(s,!0);const a=new Wt;Ye(Bt,a),Ye(ot,new Vt);let t=z(null);function I(){a.workflowStep=Te.SELECTING_MANGA_FOLDERS}function c(){if(a.workflowStep=Te.PROCESSING_MANGA,a.selectedZipFiles.length>0){const b=a.selectedZipFiles[0],T=a.zipFiles.findIndex(O=>O.file===b);T>=0&&(a.currentZipIndex=T,u(t,b,!0))}}function V(b){u(t,b,!0),a.setZipStatus(b,be.PROCESSING)}function C(){if(a.moveToNextZip()){const b=a.currentZip;b&&(u(t,b.file,!0),a.setZipStatus(b.file,be.PROCESSING))}else u(t,null)}const q=_e(()=>a.workflowStep!==Te.PROCESSING_MANGA);var F=ja(),E=r(F),L=l(r(E),2),re=r(L);re.__click=()=>qt(st("/"));var se=l(re,2);Lt(se,{}),i(L),i(E);var W=l(E,2),k=l(W,2);{var B=b=>{Ot(b,{})};Z(k,b=>{e(q)&&b(B)})}var K=l(k,2);{var G=b=>{Kt(b,{get guidedState(){return a},onDone:I,class:"uno-zgouyr"})},R=b=>{var T=Pe(),O=Se(T);{var f=M=>{ea(M,{get guidedState(){return a},onDone:c,class:"uno-l0uum8"})},y=M=>{var Y=Pe(),ie=Se(Y);{var oe=ne=>{var ee=Va(),le=r(ee);la(le,{get guidedState(){return a},onZipSelected:V,class:"uno-wgeun8"});var ue=l(le,2);{var o=h=>{La(h,{get guidedState(){return a},get zipFile(){return e(t)},onProcessingComplete:C,class:"uno-wgeun8"})},v=h=>{var d=Oa();p(h,d)};Z(ue,h=>{e(t)?h(o):h(v,!1)})}i(ee),p(ne,ee)};Z(ie,ne=>{a.workflowStep===Te.PROCESSING_MANGA&&ne(oe)},!0)}p(M,Y)};Z(O,M=>{a.workflowStep===Te.SELECTING_MANGA_FOLDERS?M(f):M(y,!1)},!0)}p(b,T)};Z(K,b=>{a.workflowStep===Te.SELECTING_ROOT_FOLDER?b(G):b(R,!1)})}i(F),U(b=>Qe(W,"href",b),[()=>st("/docs")]),p(S,F),Le()}Oe(["click"]);export{es as component,Qa as universal};
