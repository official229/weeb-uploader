import{f as b,a as f,c as Te}from"../chunks/CTHEc7mS.js";import{z as dt,A as z,B as e,C as l,D as je,E as Pe,I as r,K as o,J as i,G as H,H as Ge,aH as xe,aI as pt,u as Ce,F as Fe,aJ as it,aC as Ke,af as vt}from"../chunks/DpPdw_ub.js";import{d as Me}from"../chunks/D_Kb6Vk8.js";import{p as Se,b as Ye,i as T}from"../chunks/DxCQtHkc.js";import{r as ft,a as gt,s as Qe}from"../chunks/DofntP01.js";import{s as k}from"../chunks/CI280J2U.js";import{S as Xe,s as _e,e as qe,i as Ue,D as ht,g as mt,a as _t,t as rt,T as bt,b as xt,c as wt,C as Ve,p as yt,d as Ft,f as St,h as Et,j as Nt,k as It,l as Ct,m as zt,n as tt,o as Dt,q as Je,r as Zt,u as Tt,v as kt,Z as Rt,B as Pt,w as Gt,x as Mt,y as At,U as Lt,z as Ot,A as Vt}from"../chunks/Cl6qJq0N.js";import{b as nt,A as jt}from"../chunks/Cjq1WBUe.js";import{a as qt,r as at}from"../chunks/CxPBtbAk.js";import{g as Ut}from"../chunks/Dsvy7P0q.js";const Wt=!0,Ya=Object.freeze(Object.defineProperty({__proto__:null,prerender:Wt},Symbol.toStringTag,{value:"Module"}));var Ze=(y=>(y.SELECTING_ROOT_FOLDER="SELECTING_ROOT_FOLDER",y.SELECTING_MANGA_FOLDERS="SELECTING_MANGA_FOLDERS",y.PROCESSING_MANGA="PROCESSING_MANGA",y))(Ze||{}),pe=(y=>(y.PENDING="PENDING",y.PROCESSING="PROCESSING",y.COMPLETED="COMPLETED",y.ERROR="ERROR",y))(pe||{});class Bt{#e=z(null);get rootFolderFiles(){return e(this.#e)}set rootFolderFiles(s){l(this.#e,s,!0)}#t=z(je([]));get zipFiles(){return e(this.#t)}set zipFiles(s){l(this.#t,s,!0)}#a=z(je([]));get selectedZipFiles(){return e(this.#a)}set selectedZipFiles(s){l(this.#a,s,!0)}#s=z(-1);get currentZipIndex(){return e(this.#s)}set currentZipIndex(s){l(this.#s,s,!0)}#i=z("SELECTING_ROOT_FOLDER");get workflowStep(){return e(this.#i)}set workflowStep(s){l(this.#i,s,!0)}get currentZip(){return this.currentZipIndex<0||this.currentZipIndex>=this.zipFiles.length?null:this.zipFiles[this.currentZipIndex]}get unprocessedZips(){return this.zipFiles.filter(s=>this.selectedZipFiles.includes(s.file)&&s.status==="PENDING")}get nextZip(){const s=this.unprocessedZips;return s.length===0?null:s[0]}setZipStatus(s,a){const t=this.zipFiles.find(C=>C.file===s);t&&(t.status=a)}moveToNextZip(){const s=this.nextZip;if(!s)return!1;const a=this.zipFiles.findIndex(t=>t.file===s.file);return a>=0?(this.currentZipIndex=a,!0):!1}get zipFilesByMangaFolder(){const s=new Xe;for(const a of this.zipFiles)s.has(a.mangaFolderName)||s.set(a.mangaFolderName,[]),s.get(a.mangaFolderName).push(a);return s}reset(){this.rootFolderFiles=null,this.zipFiles=[],this.selectedZipFiles=[],this.currentZipIndex=-1,this.workflowStep="SELECTING_ROOT_FOLDER"}}const $t=dt();var Ht=b('<div class="uno-4maolu"><div class="uno-senp7v"></div> <p class="uno-l6h9uf">Scanning folder structure...</p></div>'),Jt=b('<div class="uno-laclbo"><p class="uno-dl0t86"> </p></div>'),Kt=b('<div class="uno-tm086o"><button><h1 class="uno-brv6u2">Select Root Folder</h1> <p class="uno-l6h9uf">Select the folder containing manga subfolders with .zip files</p> <input class="uno-qya2ty" type="file"/></button> <!> <!></div>');function Yt(y,s){Pe(s,!0);let a=Se(s,"guidedState",7),t=Se(s,"class",3,""),C=z(null),d=z(!1);async function V(D){l(d,!0);const W=D.target,K=Array.from(W.files??[]),G=[];for(const M of K){const R=(M.webkitRelativePath||M.name).split("/").filter(Boolean);if(R.length>=2){const O=R[0],v=R[0],w=M.name.split(".").pop()?.toLowerCase();(w==="zip"||w==="cbz")&&G.push({file:M,mangaFolderName:O,mangaFolderPath:v})}}a().rootFolderFiles=K,a().zipFiles=G.map(M=>({...M,status:pe.PENDING})),l(d,!1),s.onDone()}function F(D){e(C)?.click()}var q=Kt(),S=r(q);S.__click=F;var E=o(r(S),4);E.webkitdirectory=!0,E.multiple=!0,E.__change=V,Ye(E,D=>l(C,D),()=>e(C)),i(S);var L=o(S,2);{var re=D=>{var W=Ht();f(D,W)};T(L,D=>{e(d)&&D(re)})}var se=o(L,2);{var U=D=>{var W=Jt(),K=r(W),G=r(K);i(K),i(W),H(()=>k(G,`Found ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"}`)),f(D,W)};T(se,D=>{a().zipFiles.length>0&&D(U)})}i(q),H(()=>{_e(S,1,`uno-a4tqjo ${t()??""}`),S.disabled=e(d)}),f(y,q),Ge()}Me(["click","change"]);var Xt=b('<button type="button"><div class="uno-bpywdh"><p class="uno-98yf80"> </p> <p class="uno-42pivu"> </p></div> <input type="checkbox" class="uno-5onsv4"/></button>'),Qt=b('<div class="uno-o40niy"><div class="uno-iuhcpm"><h3 class="uno-0lb4rh"> </h3> <button type="button" class="uno-phh4jd"> </button></div> <div class="uno-fb55wk"></div></div>'),ea=b('<div><div class="uno-iuhcpm"><h2 class="uno-iyer7g">Select Zip Files to Process</h2> <button type="button" class="uno-f45w65"> </button></div> <p class="uno-ok9xip"> </p> <div class="uno-yjimjk"></div> <button type="button" class="uno-3s4o5e"> </button></div>');function ta(y,s){Pe(s,!0);let a=Se(s,"guidedState",7),t=Se(s,"class",3,"");function C(G){a().selectedZipFiles.indexOf(G)>=0?a().selectedZipFiles=a().selectedZipFiles.filter(_=>_!==G):a().selectedZipFiles=[...a().selectedZipFiles,G]}function d(G){const M=Array.from(a().zipFilesByMangaFolder.get(G)??[]);if(M.every(R=>a().selectedZipFiles.includes(R.file)))a().selectedZipFiles=a().selectedZipFiles.filter(R=>!M.some(O=>O.file===R));else{const R=M.map(O=>O.file).filter(O=>!a().selectedZipFiles.includes(O));a().selectedZipFiles=[...a().selectedZipFiles,...R]}}function V(){a().selectedZipFiles.length===a().zipFiles.length?a().selectedZipFiles=[]:a().selectedZipFiles=a().zipFiles.map(G=>G.file)}const F=xe(()=>a().zipFiles.length>0&&a().selectedZipFiles.length===a().zipFiles.length),q=xe(()=>a().zipFilesByMangaFolder);var S=ea(),E=r(S),L=o(r(E),2);L.__click=V;var re=r(L,!0);i(L),i(E);var se=o(E,2),U=r(se);i(se);var D=o(se,2);qe(D,21,()=>Array.from(e(q).entries()),Ue,(G,M)=>{var _=xe(()=>pt(e(M),2));let R=()=>e(_)[0],O=()=>e(_)[1];var v=Qt(),w=r(v),A=r(w),Y=r(A,!0);i(A);var ie=o(A,2);ie.__click=()=>d(R());var le=r(ie);i(ie),i(w);var ne=o(w,2);qe(ne,21,O,Ue,(Q,ue)=>{const ce=xe(()=>a().selectedZipFiles.includes(e(ue).file));var n=Xt();n.__click=()=>C(e(ue).file);var p=r(n),g=r(p),c=r(g,!0);i(g);var h=o(g,2),m=r(h);i(h),i(p);var x=o(p,2);ft(x),i(n),H(N=>{_e(n,1,`uno-ik4adi ${e(ce)?"uno-1k75dk":""}`),k(c,e(ue).file.name),k(m,`Size: ${N??""} MB`),gt(x,e(ce))},[()=>(e(ue).file.size/(1024*1024)).toFixed(2)]),f(Q,n)}),i(ne),i(v),H(Q=>{k(Y,R()),k(le,`${Q??""} (${O().length??""})`)},[()=>O().every(Q=>a().selectedZipFiles.includes(Q.file))?"Deselect All":"Select All"]),f(G,v)}),i(D);var W=o(D,2);W.__click=function(...G){s.onDone?.apply(this,G)};var K=r(W);i(W),i(S),H(()=>{_e(S,1,`uno-grwdkw ${t()??""}`),k(re,e(F)?"Deselect All":"Select All"),k(U,`${a().selectedZipFiles.length??""} of ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"} selected`),W.disabled=a().selectedZipFiles.length===0,k(K,`Continue to Processing (${a().selectedZipFiles.length??""} selected)`)}),f(y,S),Ge()}Me(["click"]);var aa=b('<p class="uno-a54tpo"> </p>'),sa=b('<div class="uno-cqccui"><p class="uno-nsysfu"> </p> <span> </span></div> <!>',1),ia=b('<p class="uno-b7m48p">No zip file selected</p>'),ra=b('<button type="button" class="uno-qm31yq"> </button>'),na=b('<p class="uno-b7m48p">No more zip files to process</p>'),oa=b('<p class="uno-b7m48p">All zip files have been processed</p>'),la=b('<div><div class="uno-2db0z0"><h3 class="uno-py45hl">Current Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Next Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Unprocessed Zip Files</h3> <!></div></div>');function ua(y,s){Pe(s,!0);let a=Se(s,"guidedState",7),t=Se(s,"class",3,"");function C(){if(a().moveToNextZip()){const v=a().currentZip;v&&s.onZipSelected(v.file)}}function d(v){const w=a().zipFiles.find(A=>A.file.name===v);if(w){const A=a().zipFiles.findIndex(Y=>Y.file===w.file);A>=0&&(a().currentZipIndex=A,s.onZipSelected(w.file))}}const V=xe(()=>a().currentZip?.file.name??null),F=xe(()=>a().unprocessedZips.map(v=>v.file.name)),q=xe(()=>a().nextZip?.file.name??null);let S=z(null);Ce(()=>{l(S,a().currentZip?.file.name??null,!0)}),Ce(()=>{const v=e(S);if(v){const w=a().currentZip?.file.name??null;v!==w&&d(v)}});var E=la(),L=r(E),re=o(r(L),2);{var se=v=>{var w=sa(),A=Fe(w),Y=r(A),ie=r(Y,!0);i(Y);var le=o(Y,2),ne=r(le,!0);i(le),i(A);var Q=o(A,2);{var ue=ce=>{var n=aa(),p=r(n);i(n),H(()=>k(p,`Manga Folder: ${a().currentZip.mangaFolderName??""}`)),f(ce,n)};T(Q,ce=>{a().currentZip&&ce(ue)})}H(()=>{k(ie,e(V)),_e(le,1,`uno-ielryd ${a().currentZip?.status===pe.PROCESSING?"uno-kxa2ln":a().currentZip?.status===pe.COMPLETED?"uno-b1425w":a().currentZip?.status===pe.ERROR?"uno-isu16c":"uno-jwlzg2"}`),k(ne,a().currentZip?.status??"UNKNOWN")}),f(v,w)},U=v=>{var w=ia();f(v,w)};T(re,v=>{e(V)?v(se):v(U,!1)})}i(L);var D=o(L,2),W=o(r(D),2);{var K=v=>{var w=ra();w.__click=C;var A=r(w);i(w),H(()=>k(A,`Process: ${e(q)??""}`)),f(v,w)},G=v=>{var w=na();f(v,w)};T(W,v=>{e(q)?v(K):v(G,!1)})}i(D);var M=o(D,2),_=o(r(M),2);{var R=v=>{ht(v,{get items(){return e(F)},class:"uno-qbg2l1",get selectedItem(){return e(S)},set selectedItem(w){l(S,w,!0)}})},O=v=>{var w=oa();f(v,w)};T(_,v=>{e(F).length>0?v(R):v(O,!1)})}i(M),i(E),H(()=>_e(E,1,`uno-s0eao9 ${t()??""}`)),f(y,E),Ge()}Me(["click"]);function ca(y){const s=mt(y,0);return _t(y,s,0,[])}function da(y,s="v(\\d+)"){const a=new RegExp(s,"i"),t=y.match(a);return t&&t[1]?t[1].replace(/^0+/,"")||"0":null}function pa(y,s="c(\\d+(?:\\.\\d+){0,2})"){const a=new RegExp(s,"i"),t=y.match(a);if(t&&t[1]){const C=t[1];if(C.includes(".")){const d=C.split(".");return[d[0].replace(/^0+/,"")||"0",...d.slice(1)].join(".")}else return C.replace(/^0+/,"")||"0"}return null}function va(y){const s=/MD-(\d+)/i,a=y.match(s);return a?a[1]:null}var fa=b('<span class="uno-lzl9l3 svelte-m4i47p">Removed</span>'),ga=b('<button type="button" class="uno-lj049g svelte-m4i47p" title="Edit volume and chapter" aria-label="Edit volume and chapter"><div class="uno-smkhzc svelte-m4i47p"></div></button>'),ha=b('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-m5mbjf svelte-m4i47p"></div> <span class="svelte-m4i47p">Restore</span></div>'),ma=b('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-9z7ooq svelte-m4i47p"></div> <span class="svelte-m4i47p">Remove</span></div>'),_a=b('<span class="uno-2et217 svelte-m4i47p"> </span>'),ba=b('<div class="uno-58lieu svelte-m4i47p">Loading combinations...</div>'),xa=b('<div class="uno-58lieu svelte-m4i47p">No volume/chapter combinations available</div>'),wa=b('<button type="button"><div class="uno-l6o6ga svelte-m4i47p"><span class="svelte-m4i47p"> </span></div></button>'),ya=b('<div class="uno-iqadiw svelte-m4i47p" role="presentation"><div class="uno-k7cjbm svelte-m4i47p"><!></div></div>'),Fa=b('<div><div class="uno-rzokcw svelte-m4i47p"><div class="uno-n4d6p5 svelte-m4i47p"><span class="uno-upv063 svelte-m4i47p"> </span> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Vol:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Ch:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Pages:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div></div> <button type="button"><!></button></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Title:</span> <div class="uno-aqzn48 svelte-m4i47p"><!> <!></div></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Groups:</span> <!></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Path:</span> <span class="uno-nggqeg svelte-m4i47p"> </span></div></div> <!>',1);function Sa(y,s){if(Pe(s,!0),!it(rt))throw new Error("GuidedChapterEditor must be used within a component that provides TargetingState context");let t=Se(s,"chapter",7),C=Se(s,"class",3,""),d=z(!1),V=z(je([])),F=z(!1),q=z(null),S=z(null),E=z(null),L=z(null);function re(){t().isDeleted=!t().isDeleted}async function se(){if(!e(d)){e(q)&&l(L,e(q).getBoundingClientRect(),!0),l(d,!0),l(F,!0);try{const u=t().associatedSeries?.seriesId;if(!u){console.warn("No series ID available for chapter"),l(d,!1);return}await Ve.load(),l(V,await Ve.getUniqueVolumeChapterCombinations(u),!0)}catch(u){console.error("Failed to load volume/chapter combinations:",u)}finally{l(F,!1)}}}function U(){l(d,!1),l(E,null),l(L,null)}function D(u){t().manuallyEditedFields.has("volume")||(t().originalFieldValues.has("volume")||t().originalFieldValues.set("volume",t().chapterVolume),t().manuallyEditedFields.add("volume")),t().manuallyEditedFields.has("chapter")||(t().originalFieldValues.has("chapter")||t().originalFieldValues.set("chapter",t().chapterNumber),t().manuallyEditedFields.add("chapter")),t().manuallyEditedFields.has("title")||(t().originalFieldValues.has("title")||t().originalFieldValues.set("title",t().chapterTitle),t().manuallyEditedFields.add("title")),t().chapterVolume=u.volume||null,t().chapterNumber=u.chapter||null,t().chapterTitle=u.title||null,U()}function W(u){const I=u.volume||"N/A",P=u.chapter||"N/A",Z=u.title?` - ${u.title}`:"";return`Vol ${I}, Ch ${P}${Z}`}function K(){if(!e(L))return;const u=e(L),I=window.innerHeight,P=window.innerWidth,Z=4,oe=256;let be=oe;if(e(S)){const Ne=e(S).getBoundingClientRect().height;be=Math.min(Ne,oe)}const ae=I-u.bottom-Z,Ee=u.top-Z,Ae=ae<oe&&Ee>ae;let fe;Ae?(fe=u.top-be-Z,fe<Z&&(fe=Z)):(fe=u.bottom+Z,fe+be>I&&(fe=Math.max(Z,I-be-Z)));let he=u.left;const me=320,J=Math.min(400,P-Z*2),De=Math.max(me,Math.min(J,u.width));he+De>P-Z&&(he=P-De-Z),he<Z&&(he=Z),l(E,{top:fe,left:he,width:De},!0)}Ce(()=>{if(e(d)){if(!e(L)){l(E,null);return}requestAnimationFrame(()=>{requestAnimationFrame(()=>{K()})});const u=()=>K(),I=Z=>{const oe=Z.target;e(S)&&!e(S).contains(oe)&&e(q)&&!e(q).contains(oe)&&U()},P=setTimeout(()=>{window.addEventListener("resize",u),document.addEventListener("click",I,!0)},10);return()=>{clearTimeout(P),window.removeEventListener("resize",u),document.removeEventListener("click",I,!0)}}else l(E,null)}),Ce(()=>{e(d)&&e(S)&&requestAnimationFrame(()=>{K()})});var G=Fa(),M=Fe(G),_=r(M),R=r(_),O=r(R),v=r(O);i(O);var w=o(O,2);{var A=u=>{var I=fa();f(u,I)};T(w,u=>{t().isDeleted&&u(A)})}var Y=o(w,2),ie=o(r(Y),2),le=r(ie,!0);i(ie),i(Y);var ne=o(Y,2),Q=o(r(ne),2),ue=r(Q,!0);i(Q),i(ne);var ce=o(ne,2);{var n=u=>{var I=ga();I.__click=P=>{P.stopPropagation(),se()},Ye(I,P=>l(q,P),()=>e(q)),f(u,I)};T(ce,u=>{t().associatedSeries?.seriesId&&u(n)})}var p=o(ce,2),g=o(r(p),2),c=r(g,!0);i(g),i(p),i(R);var h=o(R,2);h.__click=re;var m=r(h);{var x=u=>{var I=ha();f(u,I)},N=u=>{var I=ma();f(u,I)};T(m,u=>{t().isDeleted?u(x):u(N,!1)})}i(h),i(_);var j=o(_,2),X=o(r(j),2),B=r(X);bt(B,{textClass:"text-sm text-app font-medium",fieldName:"title",get chapter(){return t()},get value(){return t().chapterTitle},set value(u){t().chapterTitle=u}});var ee=o(B,2);{var de=u=>{var I=_a(),P=r(I);i(I),H(()=>k(P,`(${(t().originalFolderPath||"Untitled")??""})`)),f(u,I)};T(ee,u=>{t().chapterTitle||u(de)})}i(X),i(j);var $=o(j,2),te=o(r($),2);xt(te,{fieldName:"groups",get chapter(){return t()},get groups(){return t().associatedGroup},set groups(u){t().associatedGroup=u}}),i($);var ve=o($,2),we=o(r(ve),2),ke=r(we,!0);i(we),i(ve),i(M);var ze=o(M,2);{var We=u=>{var I=ya();I.__click=ae=>ae.stopPropagation();var P=r(I),Z=r(P);{var oe=ae=>{var Ee=ba();f(ae,Ee)},be=ae=>{var Ee=Te(),Ae=Fe(Ee);{var fe=me=>{var J=xa();f(me,J)},he=me=>{var J=Te(),De=Fe(J);qe(De,17,()=>e(V),Ue,(Ne,Ie)=>{var ye=wa();ye.__click=()=>D(e(Ie));var Re=r(ye),Be=r(Re),$e=r(Be,!0);i(Be),i(Re),i(ye),H(He=>{_e(ye,1,`uno-ss9yjz ${t().chapterVolume===e(Ie).volume&&t().chapterNumber===e(Ie).chapter?"uno-eokg3r":""}`,"svelte-m4i47p"),k($e,He)},[()=>W(e(Ie))]),f(Ne,ye)}),f(me,J)};T(Ae,me=>{e(V).length===0?me(fe):me(he,!1)},!0)}f(ae,Ee)};T(Z,ae=>{e(F)?ae(oe):ae(be,!1)})}i(P),i(I),Ye(I,ae=>l(S,ae),()=>e(S)),H(()=>wt(I,`top: ${e(E).top??""}px; left: ${e(E).left??""}px; width: ${e(E).width??""}px;`)),f(u,I)};T(ze,u=>{e(d)&&e(E)&&u(We)})}H(()=>{_e(M,1,`uno-3rf4hu ${t().isDeleted?"uno-d3zfvr":""} ${C()??""}`,"svelte-m4i47p"),k(v,`#${s.index+1}`),k(le,t().chapterVolume??"N/A"),k(ue,t().chapterNumber??"N/A"),k(c,t().pages.length),_e(h,1,`uno-lto8ne ${t().isDeleted?"uno-ld06wt":"uno-far8pd"}`,"svelte-m4i47p"),Qe(h,"title",t().isDeleted?"Restore chapter":"Mark as removed"),k(ke,t().originalFolderPath)}),f(y,G),Ge()}Me(["click"]);class Ea{#e=z(null);get legacyToWeebdexMap(){return e(this.#e)}set legacyToWeebdexMap(s){l(this.#e,s,!0)}#t=z(null);get weebdexToLegacyMap(){return e(this.#t)}set weebdexToLegacyMap(s){l(this.#t,s,!0)}#a=z(!1);get isLoading(){return e(this.#a)}set isLoading(s){l(this.#a,s,!0)}#s=z(null);get loadError(){return e(this.#s)}set loadError(s){l(this.#s,s,!0)}loadPromise=null;async load(){if(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)return;if(this.loadPromise)return this.loadPromise;this.isLoading=!0,this.loadError=null;let s,a;this.loadPromise=new Promise((t,C)=>{s=t,a=C});try{const t=qt("/weebdex_lookup.csv"),C=await fetch(t);if(!C.ok)throw new Error(`Failed to fetch CSV: ${C.status} ${C.statusText}`);const d=await C.text(),{legacyToWeebdex:V,weebdexToLegacy:F}=this.parseCSV(d);this.legacyToWeebdexMap=V,this.weebdexToLegacyMap=F,s()}catch(t){this.loadError=t instanceof Error?t:new Error("Unknown error loading CSV"),a(this.loadError)}finally{this.isLoading=!1}return this.loadPromise}async ensureLoaded(){if(!(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)){if(this.loadPromise){await this.loadPromise;return}await this.load()}}parseCSV(s){const a=yt(s,{columns:!0,skip_empty_lines:!0,trim:!0}),t=new Xe,C=new Xe;for(const d of a){const V=d.weebdex_id?.trim()||"",F=d.legacy_id?.trim()||"";V&&F&&(t.set(F,V),C.set(V,F))}return{legacyToWeebdex:t,weebdexToLegacy:C}}async getWeebdexIdFromLegacyId(s){return await this.ensureLoaded(),this.legacyToWeebdexMap===null?null:this.legacyToWeebdexMap.get(s)||null}}const st=new Ea;var Na=b('<p class="uno-8520et"> </p>'),Ia=b('<div class="uno-vsugad"><div class="uno-pj4440"></div> <p class="uno-hw2z5w"> </p> <!></div>'),Ca=b('<div class="uno-f2o4wl"><p class="uno-hw2z5w">Loading chapter dump and applying groups/titles...</p></div>'),za=b('<span class="uno-czmb1a">Removed</span>'),Da=b('<div class="uno-2umhxz"></div>'),Za=b('<div class="uno-kp2ftc"></div>'),Ta=b('<div><div class="uno-py2y93"><div class="uno-nxlaaf"><p class="uno-39vbxq"> </p> <!></div> <p class="uno-dsgwse"> </p></div> <button type="button"><!></button></div>'),ka=b(`<div class="uno-bi16xf"><div class="uno-nnnwwl"><div class="uno-djaa0e"><p class="uno-apr5a0"> </p> <p class="uno-lp9tww">The following chapters already exist on WeebDex with matching groups. You can mark
								them as removed to skip uploading.</p></div> <button type="button" class="uno-3jkjwc" title="Mark all duplicate chapters as removed">Removed duplicate chapters</button></div> <div class="uno-56cpuz"></div></div>`),Ra=b('<div class="uno-hemz07"><div class="uno-ns83sq"><p class="uno-0zsd1s"> </p></div> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Series Selection (Required)</h3> <!> <!> <!></div> <!> <!> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Detected Chapters</h3> <div class="uno-xqlxhl"></div></div> <button type="button" class="uno-d93lfx"> </button></div>'),Pa=b('<div class="uno-6nb6x4"><p class="uno-dillda">✓ Upload completed successfully!</p></div>'),Ga=b('<div><h2 class="uno-67n1yz"> </h2> <!></div>');function Ma(y,s){Pe(s,!0),Ft({useWebWorkers:!1});let a=Se(s,"class",3,"");const t=new St;Ke(rt,t);const C=it(nt);if(!C)throw new Error("MangaProcessor must be used within a component that provides ApiAuthContext");let d=z("loading"),V=z(null),F=z(je([])),q=z(!1),S=z(!1),E=z(null),L=z(!1),re=z(null),se=z(!1),U=z(je([]));const D=["jpg","jpeg","png","gif","webp","cbz","zip","xml"];Ce(()=>{s.zipFile&&(l(L,!1),l(re,null),l(U,[],!0),G())});async function W(n){const p=n.name.split(".").pop()?.toLowerCase();if(!(p==="cbz")&&!(p==="zip"))throw new Error(`Unsupported archive format: ${p}`);console.log(`Extracting ${p} file:`,n.name),l(E,n.name,!0);const h=new Rt(new Pt(n)),m=await h.getEntries(),x=[],N=n.name.replace(/\.(cbz|zip)$/i,""),j=n.webkitRelativePath||n.name;for(const X of m){if(!X.filename||X.directory)continue;const B=X.filename.split(".").pop()?.toLowerCase();if(!B||!D.includes(B))continue;const ee=new TransformStream,de=new Response(ee.readable).blob();await X.getData(ee.writable);let $=await de;if(!$.type){const ze=K(B);$=new Blob([$],{type:ze})}const te=X.filename,ve=te.split("/").pop()??te,we=j.includes("/")?`${j.split("/").slice(0,-1).join("/")}/${N}/${te}`:`${N}/${te}`,ke=new File([$],ve,{type:$.type});Object.defineProperty(ke,"webkitRelativePath",{value:we,writable:!1,enumerable:!0,configurable:!0}),x.push(ke)}return await h.close(),l(E,null),x}function K(n){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp"}[n]||"application/octet-stream"}async function G(){l(d,"loading"),t.reset();const n=va(s.zipFile.name);if(n)try{await st.load();const c=await st.getWeebdexIdFromLegacyId(n);c?(t.seriesId=c,console.log(`Auto-detected series ID from MD-####: ${n} -> ${c}`)):console.log(`No WeebDex ID found for MangaDex ID: ${n}`)}catch(c){console.warn(`Failed to lookup WeebDex ID for MangaDex ID ${n}:`,c)}l(d,"extracting");let p=[];try{p=await W(s.zipFile)}catch(c){console.error(`Error extracting ${s.zipFile.name}:`,c),s.guidedState.setZipStatus(s.zipFile,pe.ERROR);return}l(V,Et(p),!0);const g=ca(e(V));l(d,"extracting"),l(F,await Promise.all(g.map(async c=>{const h=da(c.name),m=pa(c.name),x=c.files.filter(N=>N.type===Nt.CHAPTER_PAGE).map((N,j)=>new It(N.file.name,j,N.file,Ct.NOT_STARTED,0,null,null,!1,N.type));return new zt(c.path,c.name,h,m,new tt,new Dt,x,Je.NOT_STARTED,0,null,null,c,!1,"en")})),!0),e(F).sort((c,h)=>{if(c.chapterVolume&&h.chapterVolume){const m=String(c.chapterVolume).localeCompare(String(h.chapterVolume),void 0,{numeric:!0,sensitivity:"base"});if(m!==0)return m}else{if(c.chapterVolume)return-1;if(h.chapterVolume)return 1}return c.chapterNumber&&h.chapterNumber?String(c.chapterNumber).localeCompare(String(h.chapterNumber),void 0,{numeric:!0,sensitivity:"base"}):c.chapterNumber?-1:h.chapterNumber?1:0}),t.chapterStates=e(F),l(d,"ready")}Ce(()=>{t.seriesId!==null&&t.chapterStates.forEach(n=>{n.associatedSeries||(n.associatedSeries=new tt),n.associatedSeries.seriesId=t.seriesId??""})}),Ce(()=>{t.seriesId&&e(d)==="ready"&&(!e(L)||t.seriesId!==e(re))&&(l(L,!0),l(re,t.seriesId,!0),l(d,"series_lookup"),M())});async function M(){if(t.seriesId)try{await Ve.load();const n=await Ve.getAllGroupNames(t.seriesId);if(n.length===0){console.warn("No groups found in chapter dump");return}const p=[];for(const g of n)try{const c=await Zt(g);if(c.data){const h=c.data.find(m=>m.name===g);if(h){const m=new Tt;m.groupId=h.id,m.groupName=h.name,p.push(m)}}}catch(c){console.warn(`Failed to lookup group "${g}":`,c)}t.availableScanGroups=p,await _(),await R(),await O(),l(d,"ready")}catch(n){console.error("Error loading chapter dump:",n),l(d,"ready")}}async function _(){for(const n of t.chapterStates){if(!n.originalFolderPath)continue;const p=t.availableScanGroups.filter(g=>n.originalFolderPath?.includes(g.groupName)??!1);if(p.length>0){const g=n.associatedGroup.groupIds??[],c=new Set(g);for(const h of p)c.has(h.groupId)||c.add(h.groupId);n.associatedGroup.groupIds=Array.from(c)}}}async function R(){if(!t.seriesId)return;const n=new Map;for(const p of t.availableScanGroups)n.set(p.groupId,p.groupName);for(const p of t.chapterStates){const g=p.associatedGroup.groupIds??[];if(g.length===0)continue;const c=g.map(x=>n.get(x)).filter(x=>x!==void 0);if(c.length===0)continue;const h=await Ve.getChapterInfo(t.seriesId,p.chapterVolume,p.chapterNumber);if(!h)continue;c.some(x=>h.groupNames.includes(x))&&(p.chapterTitle=h.title)}}async function O(){if(t.seriesId)try{const n=await kt(t.seriesId),p=[],g=new Map;for(const m of n.chapters){const x=m.volume||"none",N=m.chapter,j=`${x}:${N}`;g.set(j,m)}const c=m=>{const x=new Set;if(n.groups)for(const N of m){const j=n.groups[N];j&&x.add(j.id)}return x},h=(m,x)=>{if(m.size!==x.size)return!1;for(const N of m)if(!x.has(N))return!1;return!0};for(const m of t.chapterStates){const x=m.chapterVolume||"none",N=m.chapterNumber;if(!N)continue;const j=`${x}:${N}`,X=g.get(j);if(X&&X.entries&&Object.keys(X.entries).length>0){const B=new Set(m.associatedGroup.groupIds??[]);if(B.size===0)continue;let ee=null;for(const de of Object.values(X.entries)){const $=c(de.groups);if(h(B,$)){ee=de;break}}if(ee){const de=c(ee.groups),$=[];for(const te of de){const ve=n.groups?.find(we=>we.id===te);ve?$.push(`${ve.name} (${ve.id})`):$.push(`Unknown Group (${te})`)}p.push({chapter:m,existingGroups:$.length>0?$:["Unknown groups"]})}}}l(U,p,!0)}catch(n){console.error("Error checking for duplicates:",n),l(U,[],!0)}}function v(n){e(se)||(l(se,!0),l(q,!1),l(d,"completed"),s.guidedState.setZipStatus(s.zipFile,n?pe.COMPLETED:pe.ERROR),s.onProcessingComplete())}function w(){if(!C.apiToken){alert("Please set up API authentication first");return}if(!t.seriesId){alert("Please set a series ID first");return}if(t.chapterStates.length===0){alert("No chapters to upload");return}l(d,"uploading"),l(q,!0),l(se,!1),s.guidedState.setZipStatus(s.zipFile,pe.PROCESSING)}const A=xe(()=>e(d)==="ready"||e(d)==="series_lookup"),Y=xe(()=>e(F).filter(n=>!n.isDeleted));Ce(()=>{if(e(d)==="uploading"&&e(F).length>0){const n=e(F).every(g=>g.status===Je.COMPLETED||g.isDeleted),p=e(F).some(g=>!g.isDeleted);if(n&&p&&!e(q)){const c=!e(F).some(h=>!h.isDeleted&&h.status===Je.FAILED);s.guidedState.setZipStatus(s.zipFile,c?pe.COMPLETED:pe.ERROR),v(c)}}});var ie=Ga(),le=r(ie),ne=r(le);i(le);var Q=o(le,2);{var ue=n=>{var p=Ia(),g=o(r(p),2),c=r(g,!0);i(g);var h=o(g,2);{var m=x=>{var N=Na(),j=r(N);i(N),H(()=>k(j,`Processing: ${e(E)??""}`)),f(x,N)};T(h,x=>{e(E)&&x(m)})}i(p),H(()=>k(c,e(d)==="loading"?"Loading manga folder...":"Extracting zip files...")),f(n,p)},ce=n=>{var p=Te(),g=Fe(p);{var c=m=>{var x=Ra(),N=r(x),j=r(N),X=r(j);i(j),i(N);var B=o(N,2),ee=o(r(B),2);Gt(ee,{});var de=o(ee,2);Mt(de,{});var $=o(de,2);At($,{}),i(B);var te=o(B,2);{var ve=P=>{var Z=Ca();f(P,Z)};T(te,P=>{e(d)==="series_lookup"&&P(ve)})}var we=o(te,2);{var ke=P=>{var Z=ka(),oe=r(Z),be=r(oe),ae=r(be),Ee=r(ae);i(ae),vt(2),i(be);var Ae=o(be,2);Ae.__click=()=>{for(const{chapter:he}of e(U))he.isDeleted=!0},i(oe);var fe=o(oe,2);qe(fe,21,()=>e(U),Ue,(he,me)=>{let J=()=>e(me).chapter,De=()=>e(me).existingGroups;var Ne=Ta(),Ie=r(Ne),ye=r(Ie),Re=r(ye),Be=r(Re);i(Re);var $e=o(Re,2);{var He=ge=>{var Oe=za();f(ge,Oe)};T($e,ge=>{J().isDeleted&&ge(He)})}i(ye);var et=o(ye,2),ot=r(et);i(et),i(Ie);var Le=o(Ie,2);Le.__click=()=>{J().isDeleted=!J().isDeleted};var lt=r(Le);{var ut=ge=>{var Oe=Da();f(ge,Oe)},ct=ge=>{var Oe=Za();f(ge,Oe)};T(lt,ge=>{J().isDeleted?ge(ut):ge(ct,!1)})}i(Le),i(Ne),H(ge=>{_e(Ne,1,`uno-ecxsrr ${J().isDeleted?"uno-1ya9ju":""}`),k(Be,`Vol. ${J().chapterVolume??"N/A"??""} Ch. ${J().chapterNumber??"N/A"??""} - ${(J().chapterTitle||J().originalFolderPath||"Untitled")??""}`),k(ot,`Existing groups: ${ge??""}`),_e(Le,1,`uno-v1bdur ${J().isDeleted?"uno-uigj71":"uno-8ta9ap"}`),Qe(Le,"title",J().isDeleted?"Restore chapter":"Mark as removed")},[()=>De().join(", ")]),f(he,Ne)}),i(fe),i(Z),H(()=>k(Ee,`⚠️ Warning: ${e(U).length??""} duplicate chapter${e(U).length===1?"":"s"} detected`)),f(P,Z)};T(we,P=>{e(U).length>0&&P(ke)})}var ze=o(we,2),We=o(r(ze),2);qe(We,21,()=>e(F),Ue,(P,Z,oe)=>{Sa(P,{index:oe,get chapter(){return e(Z)}})}),i(We),i(ze);var u=o(ze,2);u.__click=w;var I=r(u);i(u),i(x),H(()=>{k(X,`Found ${e(F).length??""} chapter${e(F).length===1?"":"s"} from deepest folders`),u.disabled=!e(A)||!t.seriesId||e(Y).length===0,k(I,`Start Upload (${e(Y).length??""} of ${e(F).length??""} chapters)`)}),f(m,x)},h=m=>{var x=Te(),N=Fe(x);{var j=B=>{Lt(B,{onDone:v,get busy(){return e(S)},set busy(ee){l(S,ee,!0)}})},X=B=>{var ee=Te(),de=Fe(ee);{var $=te=>{var ve=Pa();f(te,ve)};T(de,te=>{e(d)==="completed"&&te($)},!0)}f(B,ee)};T(N,B=>{e(d)==="uploading"?B(j):B(X,!1)},!0)}f(m,x)};T(g,m=>{e(d)==="ready"||e(d)==="series_lookup"?m(c):m(h,!1)},!0)}f(n,p)};T(Q,n=>{e(d)==="loading"||e(d)==="extracting"?n(ue):n(ce,!1)})}i(ie),H(()=>{_e(ie,1,`uno-hemz07 ${a()??""}`),k(ne,`Processing: ${s.zipFile.name??""}`)}),f(y,ie),Ge()}Me(["click"]);var Aa=b('<div class="uno-j48514"><p class="uno-5v04yw">No zip file selected. Use the tabs above to select a zip file to process.</p></div>'),La=b('<div class="uno-eeu1av"><!> <!></div>'),Oa=b('<div class="uno-pb4e2u"><div class="uno-k0pcvl"><h1 class="uno-kryzyj">Guided Zip Manga Uploader</h1> <div class="uno-skt2gn"><button type="button" class="uno-q7l7gr">Simple Mode</button> <!></div></div> <a target="_blank" class="uno-6zhxse">Tutorial & Docs</a> <!> <!></div>');function Xa(y,s){Pe(s,!0);const a=new Bt;Ke($t,a),Ke(nt,new jt);let t=z(null);function C(){a.workflowStep=Ze.SELECTING_MANGA_FOLDERS}function d(){if(a.workflowStep=Ze.PROCESSING_MANGA,a.selectedZipFiles.length>0){const _=a.selectedZipFiles[0],R=a.zipFiles.findIndex(O=>O.file===_);R>=0&&(a.currentZipIndex=R,l(t,_,!0))}}function V(_){l(t,_,!0),a.setZipStatus(_,pe.PROCESSING)}function F(){if(a.moveToNextZip()){const _=a.currentZip;_&&(l(t,_.file,!0),a.setZipStatus(_.file,pe.PROCESSING))}else l(t,null)}const q=xe(()=>a.workflowStep!==Ze.PROCESSING_MANGA);var S=Oa(),E=r(S),L=o(r(E),2),re=r(L);re.__click=()=>Ut(at("/"));var se=o(re,2);Ot(se,{}),i(L),i(E);var U=o(E,2),D=o(U,2);{var W=_=>{Vt(_,{})};T(D,_=>{e(q)&&_(W)})}var K=o(D,2);{var G=_=>{Yt(_,{get guidedState(){return a},onDone:C,class:"uno-zgouyr"})},M=_=>{var R=Te(),O=Fe(R);{var v=A=>{ta(A,{get guidedState(){return a},onDone:d,class:"uno-l0uum8"})},w=A=>{var Y=Te(),ie=Fe(Y);{var le=ne=>{var Q=La(),ue=r(Q);ua(ue,{get guidedState(){return a},onZipSelected:V,class:"uno-wgeun8"});var ce=o(ue,2);{var n=g=>{Ma(g,{get guidedState(){return a},get zipFile(){return e(t)},onProcessingComplete:F,class:"uno-wgeun8"})},p=g=>{var c=Aa();f(g,c)};T(ce,g=>{e(t)?g(n):g(p,!1)})}i(Q),f(ne,Q)};T(ie,ne=>{a.workflowStep===Ze.PROCESSING_MANGA&&ne(le)},!0)}f(A,Y)};T(O,A=>{a.workflowStep===Ze.SELECTING_MANGA_FOLDERS?A(v):A(w,!1)},!0)}f(_,R)};T(K,_=>{a.workflowStep===Ze.SELECTING_ROOT_FOLDER?_(G):_(M,!1)})}i(S),H(_=>Qe(U,"href",_),[()=>at("/docs")]),f(y,S),Ge()}Me(["click"]);export{Xa as component,Ya as universal};
