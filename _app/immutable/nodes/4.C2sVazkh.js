import{f as b,a as f,c as Te}from"../chunks/CTHEc7mS.js";import{z as dt,A as z,B as e,C as l,D as je,E as Re,I as r,K as o,J as i,G as H,H as Ge,aH as xe,aI as pt,u as Ce,F as Se,aJ as it,aC as Je,af as vt}from"../chunks/DpPdw_ub.js";import{d as Me}from"../chunks/D_Kb6Vk8.js";import{p as Fe,b as Ke,i as T}from"../chunks/DxCQtHkc.js";import{r as ft,a as gt,s as Ye}from"../chunks/DofntP01.js";import{s as k}from"../chunks/CI280J2U.js";import{s as _e,e as qe,i as Ue,D as ht,g as mt,a as _t,t as rt,T as bt,b as xt,c as wt,C as Ve,p as yt,S as Qe,d as St,f as Ft,h as Et,j as Nt,k as It,l as Ct,m as zt,n as et,o as Zt,q as tt,r as Dt,u as Tt,v as kt,Z as Pt,B as Rt,w as Gt,x as Mt,y as At,U as Lt,z as Ot,A as Vt}from"../chunks/ga-rhXfY.js";import{b as nt,A as jt}from"../chunks/Cjq1WBUe.js";import{a as qt,r as at}from"../chunks/Cw9iTQau.js";import{g as Ut}from"../chunks/fCQqbTPZ.js";const Wt=!0,Ya=Object.freeze(Object.defineProperty({__proto__:null,prerender:Wt},Symbol.toStringTag,{value:"Module"}));var De=(y=>(y.SELECTING_ROOT_FOLDER="SELECTING_ROOT_FOLDER",y.SELECTING_MANGA_FOLDERS="SELECTING_MANGA_FOLDERS",y.PROCESSING_MANGA="PROCESSING_MANGA",y))(De||{}),me=(y=>(y.PENDING="PENDING",y.PROCESSING="PROCESSING",y.COMPLETED="COMPLETED",y.ERROR="ERROR",y))(me||{});class Bt{#e=z(null);get rootFolderFiles(){return e(this.#e)}set rootFolderFiles(s){l(this.#e,s,!0)}#t=z(je([]));get zipFiles(){return e(this.#t)}set zipFiles(s){l(this.#t,s,!0)}#a=z(je([]));get selectedZipFiles(){return e(this.#a)}set selectedZipFiles(s){l(this.#a,s,!0)}#s=z(-1);get currentZipIndex(){return e(this.#s)}set currentZipIndex(s){l(this.#s,s,!0)}#i=z("SELECTING_ROOT_FOLDER");get workflowStep(){return e(this.#i)}set workflowStep(s){l(this.#i,s,!0)}get currentZip(){return this.currentZipIndex<0||this.currentZipIndex>=this.zipFiles.length?null:this.zipFiles[this.currentZipIndex]}get unprocessedZips(){return this.zipFiles.filter(s=>this.selectedZipFiles.includes(s.file)&&s.status==="PENDING")}get nextZip(){const s=this.unprocessedZips;return s.length===0?null:s[0]}setZipStatus(s,a){const t=this.zipFiles.find(I=>I.file===s);t&&(t.status=a)}moveToNextZip(){const s=this.nextZip;if(!s)return!1;const a=this.zipFiles.findIndex(t=>t.file===s.file);return a>=0?(this.currentZipIndex=a,!0):!1}get zipFilesByMangaFolder(){const s=new Map;for(const a of this.zipFiles)s.has(a.mangaFolderName)||s.set(a.mangaFolderName,[]),s.get(a.mangaFolderName).push(a);return s}reset(){this.rootFolderFiles=null,this.zipFiles=[],this.selectedZipFiles=[],this.currentZipIndex=-1,this.workflowStep="SELECTING_ROOT_FOLDER"}}const $t=dt();var Ht=b('<div class="uno-4maolu"><div class="uno-senp7v"></div> <p class="uno-l6h9uf">Scanning folder structure...</p></div>'),Jt=b('<div class="uno-laclbo"><p class="uno-dl0t86"> </p></div>'),Kt=b('<div class="uno-tm086o"><button><h1 class="uno-brv6u2">Select Root Folder</h1> <p class="uno-l6h9uf">Select the folder containing manga subfolders with .zip files</p> <input class="uno-qya2ty" type="file"/></button> <!> <!></div>');function Yt(y,s){Re(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,""),I=z(null),c=z(!1);async function V(Z){l(c,!0);const W=Z.target,K=Array.from(W.files??[]),G=[];for(const M of K){const P=(M.webkitRelativePath||M.name).split("/").filter(Boolean);if(P.length>=2){const O=P[0],v=P[0],w=M.name.split(".").pop()?.toLowerCase();(w==="zip"||w==="cbz")&&G.push({file:M,mangaFolderName:O,mangaFolderPath:v})}}a().rootFolderFiles=K,a().zipFiles=G.map(M=>({...M,status:me.PENDING})),l(c,!1),s.onDone()}function C(Z){e(I)?.click()}var q=Kt(),S=r(q);S.__click=C;var F=o(r(S),4);F.webkitdirectory=!0,F.multiple=!0,F.__change=V,Ke(F,Z=>l(I,Z),()=>e(I)),i(S);var L=o(S,2);{var re=Z=>{var W=Ht();f(Z,W)};T(L,Z=>{e(c)&&Z(re)})}var se=o(L,2);{var U=Z=>{var W=Jt(),K=r(W),G=r(K);i(K),i(W),H(()=>k(G,`Found ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"}`)),f(Z,W)};T(se,Z=>{a().zipFiles.length>0&&Z(U)})}i(q),H(()=>{_e(S,1,`uno-a4tqjo ${t()??""}`),S.disabled=e(c)}),f(y,q),Ge()}Me(["click","change"]);var Xt=b('<button type="button"><div class="uno-bpywdh"><p class="uno-98yf80"> </p> <p class="uno-42pivu"> </p></div> <input type="checkbox" class="uno-5onsv4"/></button>'),Qt=b('<div class="uno-o40niy"><div class="uno-iuhcpm"><h3 class="uno-0lb4rh"> </h3> <button type="button" class="uno-phh4jd"> </button></div> <div class="uno-fb55wk"></div></div>'),ea=b('<div><div class="uno-iuhcpm"><h2 class="uno-iyer7g">Select Zip Files to Process</h2> <button type="button" class="uno-f45w65"> </button></div> <p class="uno-ok9xip"> </p> <div class="uno-yjimjk"></div> <button type="button" class="uno-3s4o5e"> </button></div>');function ta(y,s){Re(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,"");function I(G){a().selectedZipFiles.indexOf(G)>=0?a().selectedZipFiles=a().selectedZipFiles.filter(m=>m!==G):a().selectedZipFiles=[...a().selectedZipFiles,G]}function c(G){const M=Array.from(a().zipFilesByMangaFolder.get(G)??[]);if(M.every(P=>a().selectedZipFiles.includes(P.file)))a().selectedZipFiles=a().selectedZipFiles.filter(P=>!M.some(O=>O.file===P));else{const P=M.map(O=>O.file).filter(O=>!a().selectedZipFiles.includes(O));a().selectedZipFiles=[...a().selectedZipFiles,...P]}}function V(){a().selectedZipFiles.length===a().zipFiles.length?a().selectedZipFiles=[]:a().selectedZipFiles=a().zipFiles.map(G=>G.file)}const C=xe(()=>a().zipFiles.length>0&&a().selectedZipFiles.length===a().zipFiles.length),q=xe(()=>a().zipFilesByMangaFolder);var S=ea(),F=r(S),L=o(r(F),2);L.__click=V;var re=r(L,!0);i(L),i(F);var se=o(F,2),U=r(se);i(se);var Z=o(se,2);qe(Z,21,()=>Array.from(e(q).entries()),Ue,(G,M)=>{var m=xe(()=>pt(e(M),2));let P=()=>e(m)[0],O=()=>e(m)[1];var v=Qt(),w=r(v),A=r(w),Y=r(A,!0);i(A);var ie=o(A,2);ie.__click=()=>c(P());var le=r(ie);i(ie),i(w);var ne=o(w,2);qe(ne,21,O,Ue,(Q,ue)=>{const ce=xe(()=>a().selectedZipFiles.includes(e(ue).file));var n=Xt();n.__click=()=>I(e(ue).file);var p=r(n),g=r(p),d=r(g,!0);i(g);var _=o(g,2),h=r(_);i(_),i(p);var x=o(p,2);ft(x),i(n),H(E=>{_e(n,1,`uno-ik4adi ${e(ce)?"uno-1k75dk":""}`),k(d,e(ue).file.name),k(h,`Size: ${E??""} MB`),gt(x,e(ce))},[()=>(e(ue).file.size/(1024*1024)).toFixed(2)]),f(Q,n)}),i(ne),i(v),H(Q=>{k(Y,P()),k(le,`${Q??""} (${O().length??""})`)},[()=>O().every(Q=>a().selectedZipFiles.includes(Q.file))?"Deselect All":"Select All"]),f(G,v)}),i(Z);var W=o(Z,2);W.__click=function(...G){s.onDone?.apply(this,G)};var K=r(W);i(W),i(S),H(()=>{_e(S,1,`uno-grwdkw ${t()??""}`),k(re,e(C)?"Deselect All":"Select All"),k(U,`${a().selectedZipFiles.length??""} of ${a().zipFiles.length??""} zip file${a().zipFiles.length===1?"":"s"} selected`),W.disabled=a().selectedZipFiles.length===0,k(K,`Continue to Processing (${a().selectedZipFiles.length??""} selected)`)}),f(y,S),Ge()}Me(["click"]);var aa=b('<p class="uno-a54tpo"> </p>'),sa=b('<div class="uno-cqccui"><p class="uno-nsysfu"> </p> <span> </span></div> <!>',1),ia=b('<p class="uno-b7m48p">No zip file selected</p>'),ra=b('<button type="button" class="uno-qm31yq"> </button>'),na=b('<p class="uno-b7m48p">No more zip files to process</p>'),oa=b('<p class="uno-b7m48p">All zip files have been processed</p>'),la=b('<div><div class="uno-2db0z0"><h3 class="uno-py45hl">Current Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Next Zip File</h3> <!></div> <div class="uno-2db0z0"><h3 class="uno-py45hl">Unprocessed Zip Files</h3> <!></div></div>');function ua(y,s){Re(s,!0);let a=Fe(s,"guidedState",7),t=Fe(s,"class",3,"");function I(){if(a().moveToNextZip()){const v=a().currentZip;v&&s.onZipSelected(v.file)}}function c(v){const w=a().zipFiles.find(A=>A.file.name===v);if(w){const A=a().zipFiles.findIndex(Y=>Y.file===w.file);A>=0&&(a().currentZipIndex=A,s.onZipSelected(w.file))}}const V=xe(()=>a().currentZip?.file.name??null),C=xe(()=>a().unprocessedZips.map(v=>v.file.name)),q=xe(()=>a().nextZip?.file.name??null);let S=z(null);Ce(()=>{l(S,a().currentZip?.file.name??null,!0)}),Ce(()=>{const v=e(S);if(v){const w=a().currentZip?.file.name??null;v!==w&&c(v)}});var F=la(),L=r(F),re=o(r(L),2);{var se=v=>{var w=sa(),A=Se(w),Y=r(A),ie=r(Y,!0);i(Y);var le=o(Y,2),ne=r(le,!0);i(le),i(A);var Q=o(A,2);{var ue=ce=>{var n=aa(),p=r(n);i(n),H(()=>k(p,`Manga Folder: ${a().currentZip.mangaFolderName??""}`)),f(ce,n)};T(Q,ce=>{a().currentZip&&ce(ue)})}H(()=>{k(ie,e(V)),_e(le,1,`uno-ielryd ${a().currentZip?.status===me.PROCESSING?"uno-kxa2ln":a().currentZip?.status===me.COMPLETED?"uno-b1425w":a().currentZip?.status===me.ERROR?"uno-isu16c":"uno-jwlzg2"}`),k(ne,a().currentZip?.status??"UNKNOWN")}),f(v,w)},U=v=>{var w=ia();f(v,w)};T(re,v=>{e(V)?v(se):v(U,!1)})}i(L);var Z=o(L,2),W=o(r(Z),2);{var K=v=>{var w=ra();w.__click=I;var A=r(w);i(w),H(()=>k(A,`Process: ${e(q)??""}`)),f(v,w)},G=v=>{var w=na();f(v,w)};T(W,v=>{e(q)?v(K):v(G,!1)})}i(Z);var M=o(Z,2),m=o(r(M),2);{var P=v=>{ht(v,{get items(){return e(C)},class:"uno-qbg2l1",get selectedItem(){return e(S)},set selectedItem(w){l(S,w,!0)}})},O=v=>{var w=oa();f(v,w)};T(m,v=>{e(C).length>0?v(P):v(O,!1)})}i(M),i(F),H(()=>_e(F,1,`uno-s0eao9 ${t()??""}`)),f(y,F),Ge()}Me(["click"]);function ca(y){const s=mt(y,0);return _t(y,s,0,[])}function da(y,s="v(\\d+)"){const a=new RegExp(s,"i"),t=y.match(a);return t&&t[1]?t[1].replace(/^0+/,"")||"0":null}function pa(y,s="c(\\d+(?:\\.\\d+){0,2})"){const a=new RegExp(s,"i"),t=y.match(a);if(t&&t[1]){const I=t[1];if(I.includes(".")){const c=I.split(".");return[c[0].replace(/^0+/,"")||"0",...c.slice(1)].join(".")}else return I.replace(/^0+/,"")||"0"}return null}function va(y){const s=/MD-(\d+)/i,a=y.match(s);return a?a[1]:null}var fa=b('<span class="uno-lzl9l3 svelte-m4i47p">Removed</span>'),ga=b('<button type="button" class="uno-lj049g svelte-m4i47p" title="Edit volume and chapter" aria-label="Edit volume and chapter"><div class="uno-smkhzc svelte-m4i47p"></div></button>'),ha=b('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-m5mbjf svelte-m4i47p"></div> <span class="svelte-m4i47p">Restore</span></div>'),ma=b('<div class="uno-7qt2lg svelte-m4i47p"><div class="uno-9z7ooq svelte-m4i47p"></div> <span class="svelte-m4i47p">Remove</span></div>'),_a=b('<span class="uno-2et217 svelte-m4i47p"> </span>'),ba=b('<div class="uno-58lieu svelte-m4i47p">Loading combinations...</div>'),xa=b('<div class="uno-58lieu svelte-m4i47p">No volume/chapter combinations available</div>'),wa=b('<button type="button"><div class="uno-l6o6ga svelte-m4i47p"><span class="svelte-m4i47p"> </span></div></button>'),ya=b('<div class="uno-iqadiw svelte-m4i47p" role="presentation"><div class="uno-k7cjbm svelte-m4i47p"><!></div></div>'),Sa=b('<div><div class="uno-rzokcw svelte-m4i47p"><div class="uno-n4d6p5 svelte-m4i47p"><span class="uno-upv063 svelte-m4i47p"> </span> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Vol:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Ch:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div> <!> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Pages:</span> <span class="uno-4g5bui svelte-m4i47p"> </span></div></div> <button type="button"><!></button></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Title:</span> <div class="uno-aqzn48 svelte-m4i47p"><!> <!></div></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Groups:</span> <!></div> <div class="uno-0yx623 svelte-m4i47p"><span class="uno-7f6l2t svelte-m4i47p">Path:</span> <span class="uno-nggqeg svelte-m4i47p"> </span></div></div> <!>',1);function Fa(y,s){if(Re(s,!0),!it(rt))throw new Error("GuidedChapterEditor must be used within a component that provides TargetingState context");let t=Fe(s,"chapter",7),I=Fe(s,"class",3,""),c=z(!1),V=z(je([])),C=z(!1),q=z(null),S=z(null),F=z(null),L=z(null);function re(){t().isDeleted=!t().isDeleted}async function se(){if(!e(c)){e(q)&&l(L,e(q).getBoundingClientRect(),!0),l(c,!0),l(C,!0);try{const u=t().associatedSeries?.seriesId;if(!u){console.warn("No series ID available for chapter"),l(c,!1);return}await Ve.load(),l(V,await Ve.getUniqueVolumeChapterCombinations(u),!0)}catch(u){console.error("Failed to load volume/chapter combinations:",u)}finally{l(C,!1)}}}function U(){l(c,!1),l(F,null),l(L,null)}function Z(u){t().manuallyEditedFields.has("volume")||(t().originalFieldValues.has("volume")||t().originalFieldValues.set("volume",t().chapterVolume),t().manuallyEditedFields.add("volume")),t().manuallyEditedFields.has("chapter")||(t().originalFieldValues.has("chapter")||t().originalFieldValues.set("chapter",t().chapterNumber),t().manuallyEditedFields.add("chapter")),t().manuallyEditedFields.has("title")||(t().originalFieldValues.has("title")||t().originalFieldValues.set("title",t().chapterTitle),t().manuallyEditedFields.add("title")),t().chapterVolume=u.volume||null,t().chapterNumber=u.chapter||null,t().chapterTitle=u.title||null,U()}function W(u){const N=u.volume||"N/A",R=u.chapter||"N/A",D=u.title?` - ${u.title}`:"";return`Vol ${N}, Ch ${R}${D}`}function K(){if(!e(L))return;const u=e(L),N=window.innerHeight,R=window.innerWidth,D=4,oe=256;let be=oe;if(e(S)){const Ne=e(S).getBoundingClientRect().height;be=Math.min(Ne,oe)}const ae=N-u.bottom-D,Ee=u.top-D,Ae=ae<oe&&Ee>ae;let ve;Ae?(ve=u.top-be-D,ve<D&&(ve=D)):(ve=u.bottom+D,ve+be>N&&(ve=Math.max(D,N-be-D)));let ge=u.left;const he=320,J=Math.min(400,R-D*2),Ze=Math.max(he,Math.min(J,u.width));ge+Ze>R-D&&(ge=R-Ze-D),ge<D&&(ge=D),l(F,{top:ve,left:ge,width:Ze},!0)}Ce(()=>{if(e(c)){if(!e(L)){l(F,null);return}requestAnimationFrame(()=>{requestAnimationFrame(()=>{K()})});const u=()=>K(),N=D=>{const oe=D.target;e(S)&&!e(S).contains(oe)&&e(q)&&!e(q).contains(oe)&&U()},R=setTimeout(()=>{window.addEventListener("resize",u),document.addEventListener("click",N,!0)},10);return()=>{clearTimeout(R),window.removeEventListener("resize",u),document.removeEventListener("click",N,!0)}}else l(F,null)}),Ce(()=>{e(c)&&e(S)&&requestAnimationFrame(()=>{K()})});var G=Sa(),M=Se(G),m=r(M),P=r(m),O=r(P),v=r(O);i(O);var w=o(O,2);{var A=u=>{var N=fa();f(u,N)};T(w,u=>{t().isDeleted&&u(A)})}var Y=o(w,2),ie=o(r(Y),2),le=r(ie,!0);i(ie),i(Y);var ne=o(Y,2),Q=o(r(ne),2),ue=r(Q,!0);i(Q),i(ne);var ce=o(ne,2);{var n=u=>{var N=ga();N.__click=R=>{R.stopPropagation(),se()},Ke(N,R=>l(q,R),()=>e(q)),f(u,N)};T(ce,u=>{t().associatedSeries?.seriesId&&u(n)})}var p=o(ce,2),g=o(r(p),2),d=r(g,!0);i(g),i(p),i(P);var _=o(P,2);_.__click=re;var h=r(_);{var x=u=>{var N=ha();f(u,N)},E=u=>{var N=ma();f(u,N)};T(h,u=>{t().isDeleted?u(x):u(E,!1)})}i(_),i(m);var j=o(m,2),X=o(r(j),2),B=r(X);bt(B,{textClass:"text-sm text-app font-medium",fieldName:"title",get chapter(){return t()},get value(){return t().chapterTitle},set value(u){t().chapterTitle=u}});var ee=o(B,2);{var de=u=>{var N=_a(),R=r(N);i(N),H(()=>k(R,`(${(t().originalFolderPath||"Untitled")??""})`)),f(u,N)};T(ee,u=>{t().chapterTitle||u(de)})}i(X),i(j);var $=o(j,2),te=o(r($),2);xt(te,{fieldName:"groups",get chapter(){return t()},get groups(){return t().associatedGroup},set groups(u){t().associatedGroup=u}}),i($);var pe=o($,2),we=o(r(pe),2),ke=r(we,!0);i(we),i(pe),i(M);var ze=o(M,2);{var We=u=>{var N=ya();N.__click=ae=>ae.stopPropagation();var R=r(N),D=r(R);{var oe=ae=>{var Ee=ba();f(ae,Ee)},be=ae=>{var Ee=Te(),Ae=Se(Ee);{var ve=he=>{var J=xa();f(he,J)},ge=he=>{var J=Te(),Ze=Se(J);qe(Ze,17,()=>e(V),Ue,(Ne,Ie)=>{var ye=wa();ye.__click=()=>Z(e(Ie));var Pe=r(ye),Be=r(Pe),$e=r(Be,!0);i(Be),i(Pe),i(ye),H(He=>{_e(ye,1,`uno-ss9yjz ${t().chapterVolume===e(Ie).volume&&t().chapterNumber===e(Ie).chapter?"uno-eokg3r":""}`,"svelte-m4i47p"),k($e,He)},[()=>W(e(Ie))]),f(Ne,ye)}),f(he,J)};T(Ae,he=>{e(V).length===0?he(ve):he(ge,!1)},!0)}f(ae,Ee)};T(D,ae=>{e(C)?ae(oe):ae(be,!1)})}i(R),i(N),Ke(N,ae=>l(S,ae),()=>e(S)),H(()=>wt(N,`top: ${e(F).top??""}px; left: ${e(F).left??""}px; width: ${e(F).width??""}px;`)),f(u,N)};T(ze,u=>{e(c)&&e(F)&&u(We)})}H(()=>{_e(M,1,`uno-3rf4hu ${t().isDeleted?"uno-d3zfvr":""} ${I()??""}`,"svelte-m4i47p"),k(v,`#${s.index+1}`),k(le,t().chapterVolume??"N/A"),k(ue,t().chapterNumber??"N/A"),k(d,t().pages.length),_e(_,1,`uno-lto8ne ${t().isDeleted?"uno-ld06wt":"uno-far8pd"}`,"svelte-m4i47p"),Ye(_,"title",t().isDeleted?"Restore chapter":"Mark as removed"),k(ke,t().originalFolderPath)}),f(y,G),Ge()}Me(["click"]);class Ea{#e=z(null);get legacyToWeebdexMap(){return e(this.#e)}set legacyToWeebdexMap(s){l(this.#e,s,!0)}#t=z(null);get weebdexToLegacyMap(){return e(this.#t)}set weebdexToLegacyMap(s){l(this.#t,s,!0)}#a=z(!1);get isLoading(){return e(this.#a)}set isLoading(s){l(this.#a,s,!0)}#s=z(null);get loadError(){return e(this.#s)}set loadError(s){l(this.#s,s,!0)}loadPromise=null;async load(){if(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)return;if(this.loadPromise)return this.loadPromise;this.isLoading=!0,this.loadError=null;let s,a;this.loadPromise=new Promise((t,I)=>{s=t,a=I});try{const t=qt("/weebdex_lookup.csv"),I=await fetch(t);if(!I.ok)throw new Error(`Failed to fetch CSV: ${I.status} ${I.statusText}`);const c=await I.text(),{legacyToWeebdex:V,weebdexToLegacy:C}=this.parseCSV(c);this.legacyToWeebdexMap=V,this.weebdexToLegacyMap=C,s()}catch(t){this.loadError=t instanceof Error?t:new Error("Unknown error loading CSV"),a(this.loadError)}finally{this.isLoading=!1}return this.loadPromise}async ensureLoaded(){if(!(this.legacyToWeebdexMap!==null&&this.weebdexToLegacyMap!==null)){if(this.loadPromise){await this.loadPromise;return}await this.load()}}parseCSV(s){const a=yt(s,{columns:!0,skip_empty_lines:!0,trim:!0}),t=new Qe,I=new Qe;for(const c of a){const V=c.weebdex_id?.trim()||"",C=c.legacy_id?.trim()||"";V&&C&&(t.set(C,V),I.set(V,C))}return{legacyToWeebdex:t,weebdexToLegacy:I}}async getWeebdexIdFromLegacyId(s){return await this.ensureLoaded(),this.legacyToWeebdexMap===null?null:this.legacyToWeebdexMap.get(s)||null}}const st=new Ea;var Na=b('<p class="uno-8520et"> </p>'),Ia=b('<div class="uno-vsugad"><div class="uno-pj4440"></div> <p class="uno-hw2z5w"> </p> <!></div>'),Ca=b('<div class="uno-f2o4wl"><p class="uno-hw2z5w">Loading chapter dump and applying groups/titles...</p></div>'),za=b('<span class="uno-czmb1a">Removed</span>'),Za=b('<div class="uno-2umhxz"></div>'),Da=b('<div class="uno-kp2ftc"></div>'),Ta=b('<div><div class="uno-py2y93"><div class="uno-nxlaaf"><p class="uno-39vbxq"> </p> <!></div> <p class="uno-dsgwse"> </p></div> <button type="button"><!></button></div>'),ka=b(`<div class="uno-bi16xf"><div class="uno-nnnwwl"><div class="uno-djaa0e"><p class="uno-apr5a0"> </p> <p class="uno-lp9tww">The following chapters already exist on WeebDex with matching groups. You can mark
								them as removed to skip uploading.</p></div> <button type="button" class="uno-3jkjwc" title="Mark all duplicate chapters as removed">Removed duplicate chapters</button></div> <div class="uno-56cpuz"></div></div>`),Pa=b('<div class="uno-hemz07"><div class="uno-ns83sq"><p class="uno-0zsd1s"> </p></div> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Series Selection (Required)</h3> <!> <!> <!></div> <!> <!> <div class="uno-f2o4wl"><h3 class="uno-otxjpc">Detected Chapters</h3> <div class="uno-xqlxhl"></div></div> <button type="button" class="uno-d93lfx"> </button></div>'),Ra=b('<div class="uno-6nb6x4"><p class="uno-dillda">✓ Upload completed successfully!</p></div>'),Ga=b('<div><h2 class="uno-67n1yz"> </h2> <!></div>');function Ma(y,s){Re(s,!0),St({useWebWorkers:!1});let a=Fe(s,"class",3,"");const t=new Ft;Je(rt,t);const I=it(nt);if(!I)throw new Error("MangaProcessor must be used within a component that provides ApiAuthContext");let c=z("loading"),V=z(null),C=z(je([])),q=z(!1),S=z(!1),F=z(null),L=z(!1),re=z(null),se=z(!1),U=z(je([]));const Z=["jpg","jpeg","png","gif","webp","cbz","zip","xml"];Ce(()=>{s.zipFile&&(l(L,!1),l(re,null),l(U,[],!0),G())});async function W(n){const p=n.name.split(".").pop()?.toLowerCase();if(!(p==="cbz")&&!(p==="zip"))throw new Error(`Unsupported archive format: ${p}`);console.log(`Extracting ${p} file:`,n.name),l(F,n.name,!0);const _=new Pt(new Rt(n)),h=await _.getEntries(),x=[],E=n.name.replace(/\.(cbz|zip)$/i,""),j=n.webkitRelativePath||n.name;for(const X of h){if(!X.filename||X.directory)continue;const B=X.filename.split(".").pop()?.toLowerCase();if(!B||!Z.includes(B))continue;const ee=new TransformStream,de=new Response(ee.readable).blob();await X.getData(ee.writable);let $=await de;if(!$.type){const ze=K(B);$=new Blob([$],{type:ze})}const te=X.filename,pe=te.split("/").pop()??te,we=j.includes("/")?`${j.split("/").slice(0,-1).join("/")}/${E}/${te}`:`${E}/${te}`,ke=new File([$],pe,{type:$.type});Object.defineProperty(ke,"webkitRelativePath",{value:we,writable:!1,enumerable:!0,configurable:!0}),x.push(ke)}return await _.close(),l(F,null),x}function K(n){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp"}[n]||"application/octet-stream"}async function G(){l(c,"loading"),t.reset();const n=va(s.zipFile.name);if(n)try{await st.load();const d=await st.getWeebdexIdFromLegacyId(n);d?(t.seriesId=d,console.log(`Auto-detected series ID from MD-####: ${n} -> ${d}`)):console.log(`No WeebDex ID found for MangaDex ID: ${n}`)}catch(d){console.warn(`Failed to lookup WeebDex ID for MangaDex ID ${n}:`,d)}l(c,"extracting");let p=[];try{p=await W(s.zipFile)}catch(d){console.error(`Error extracting ${s.zipFile.name}:`,d),s.guidedState.setZipStatus(s.zipFile,me.ERROR);return}l(V,Et(p),!0);const g=ca(e(V));l(c,"extracting"),l(C,await Promise.all(g.map(async d=>{const _=da(d.name),h=pa(d.name),x=d.files.filter(E=>E.type===Nt.CHAPTER_PAGE).map((E,j)=>new It(E.file.name,j,E.file,Ct.NOT_STARTED,0,null,null,!1,E.type));return new zt(d.path,d.name,_,h,new et,new Zt,x,tt.NOT_STARTED,0,null,null,d,!1,"en")})),!0),e(C).sort((d,_)=>{if(d.chapterVolume&&_.chapterVolume){const h=String(d.chapterVolume).localeCompare(String(_.chapterVolume),void 0,{numeric:!0,sensitivity:"base"});if(h!==0)return h}else{if(d.chapterVolume)return-1;if(_.chapterVolume)return 1}return d.chapterNumber&&_.chapterNumber?String(d.chapterNumber).localeCompare(String(_.chapterNumber),void 0,{numeric:!0,sensitivity:"base"}):d.chapterNumber?-1:_.chapterNumber?1:0}),t.chapterStates=e(C),l(c,"ready")}Ce(()=>{t.seriesId!==null&&t.chapterStates.forEach(n=>{n.associatedSeries||(n.associatedSeries=new et),n.associatedSeries.seriesId=t.seriesId??""})}),Ce(()=>{t.seriesId&&e(c)==="ready"&&(!e(L)||t.seriesId!==e(re))&&(l(L,!0),l(re,t.seriesId,!0),l(c,"series_lookup"),M())});async function M(){if(t.seriesId)try{await Ve.load();const n=await Ve.getAllGroupNames(t.seriesId);if(n.length===0){console.warn("No groups found in chapter dump");return}const p=[];for(const g of n)try{const d=await Dt(g);if(d.data){const _=d.data.find(h=>h.name===g);if(_){const h=new Tt;h.groupId=_.id,h.groupName=_.name,p.push(h)}}}catch(d){console.warn(`Failed to lookup group "${g}":`,d)}t.availableScanGroups=p,await m(),await P(),await O(),l(c,"ready")}catch(n){console.error("Error loading chapter dump:",n),l(c,"ready")}}async function m(){for(const n of t.chapterStates){if(!n.originalFolderPath)continue;const p=t.availableScanGroups.filter(g=>n.originalFolderPath?.includes(g.groupName)??!1);if(p.length>0){const g=n.associatedGroup.groupIds??[],d=new Set(g);for(const _ of p)d.has(_.groupId)||d.add(_.groupId);n.associatedGroup.groupIds=Array.from(d)}}}async function P(){if(!t.seriesId)return;const n=new Map;for(const p of t.availableScanGroups)n.set(p.groupId,p.groupName);for(const p of t.chapterStates){const g=p.associatedGroup.groupIds??[];if(g.length===0)continue;const d=g.map(x=>n.get(x)).filter(x=>x!==void 0);if(d.length===0)continue;const _=await Ve.getChapterInfo(t.seriesId,p.chapterVolume,p.chapterNumber);if(!_)continue;d.some(x=>_.groupNames.includes(x))&&(p.chapterTitle=_.title)}}async function O(){if(t.seriesId)try{const n=await kt(t.seriesId),p=[],g=new Map;for(const h of n.chapters){const x=h.volume||"none",E=h.chapter,j=`${x}:${E}`;g.set(j,h)}const d=h=>{const x=new Set;if(n.groups)for(const E of h){const j=n.groups[E];j&&x.add(j.id)}return x},_=(h,x)=>{if(h.size!==x.size)return!1;for(const E of h)if(!x.has(E))return!1;return!0};for(const h of t.chapterStates){const x=h.chapterVolume||"none",E=h.chapterNumber;if(!E)continue;const j=`${x}:${E}`,X=g.get(j);if(X&&X.entries&&Object.keys(X.entries).length>0){const B=new Set(h.associatedGroup.groupIds??[]);if(B.size===0)continue;let ee=null;for(const de of Object.values(X.entries)){const $=d(de.groups);if(_(B,$)){ee=de;break}}if(ee){const de=d(ee.groups),$=[];for(const te of de){const pe=n.groups?.find(we=>we.id===te);pe?$.push(`${pe.name} (${pe.id})`):$.push(`Unknown Group (${te})`)}p.push({chapter:h,existingGroups:$.length>0?$:["Unknown groups"]})}}}l(U,p,!0)}catch(n){console.error("Error checking for duplicates:",n),l(U,[],!0)}}function v(){e(se)||(l(se,!0),l(q,!1),l(c,"completed"),s.guidedState.setZipStatus(s.zipFile,me.COMPLETED),s.onProcessingComplete())}function w(){if(!I.apiToken){alert("Please set up API authentication first");return}if(!t.seriesId){alert("Please set a series ID first");return}if(t.chapterStates.length===0){alert("No chapters to upload");return}l(c,"uploading"),l(q,!0),l(se,!1),s.guidedState.setZipStatus(s.zipFile,me.PROCESSING)}const A=xe(()=>e(c)==="ready"||e(c)==="series_lookup"),Y=xe(()=>e(C).filter(n=>!n.isDeleted));Ce(()=>{if(e(c)==="uploading"&&e(C).length>0){const n=e(C).every(g=>g.status===tt.COMPLETED||g.isDeleted),p=e(C).some(g=>!g.isDeleted);n&&p&&!e(q)&&(s.guidedState.setZipStatus(s.zipFile,me.COMPLETED),v())}});var ie=Ga(),le=r(ie),ne=r(le);i(le);var Q=o(le,2);{var ue=n=>{var p=Ia(),g=o(r(p),2),d=r(g,!0);i(g);var _=o(g,2);{var h=x=>{var E=Na(),j=r(E);i(E),H(()=>k(j,`Processing: ${e(F)??""}`)),f(x,E)};T(_,x=>{e(F)&&x(h)})}i(p),H(()=>k(d,e(c)==="loading"?"Loading manga folder...":"Extracting zip files...")),f(n,p)},ce=n=>{var p=Te(),g=Se(p);{var d=h=>{var x=Pa(),E=r(x),j=r(E),X=r(j);i(j),i(E);var B=o(E,2),ee=o(r(B),2);Gt(ee,{});var de=o(ee,2);Mt(de,{});var $=o(de,2);At($,{}),i(B);var te=o(B,2);{var pe=R=>{var D=Ca();f(R,D)};T(te,R=>{e(c)==="series_lookup"&&R(pe)})}var we=o(te,2);{var ke=R=>{var D=ka(),oe=r(D),be=r(oe),ae=r(be),Ee=r(ae);i(ae),vt(2),i(be);var Ae=o(be,2);Ae.__click=()=>{for(const{chapter:ge}of e(U))ge.isDeleted=!0},i(oe);var ve=o(oe,2);qe(ve,21,()=>e(U),Ue,(ge,he)=>{let J=()=>e(he).chapter,Ze=()=>e(he).existingGroups;var Ne=Ta(),Ie=r(Ne),ye=r(Ie),Pe=r(ye),Be=r(Pe);i(Pe);var $e=o(Pe,2);{var He=fe=>{var Oe=za();f(fe,Oe)};T($e,fe=>{J().isDeleted&&fe(He)})}i(ye);var Xe=o(ye,2),ot=r(Xe);i(Xe),i(Ie);var Le=o(Ie,2);Le.__click=()=>{J().isDeleted=!J().isDeleted};var lt=r(Le);{var ut=fe=>{var Oe=Za();f(fe,Oe)},ct=fe=>{var Oe=Da();f(fe,Oe)};T(lt,fe=>{J().isDeleted?fe(ut):fe(ct,!1)})}i(Le),i(Ne),H(fe=>{_e(Ne,1,`uno-ecxsrr ${J().isDeleted?"uno-1ya9ju":""}`),k(Be,`Vol. ${J().chapterVolume??"N/A"??""} Ch. ${J().chapterNumber??"N/A"??""} - ${(J().chapterTitle||J().originalFolderPath||"Untitled")??""}`),k(ot,`Existing groups: ${fe??""}`),_e(Le,1,`uno-v1bdur ${J().isDeleted?"uno-uigj71":"uno-8ta9ap"}`),Ye(Le,"title",J().isDeleted?"Restore chapter":"Mark as removed")},[()=>Ze().join(", ")]),f(ge,Ne)}),i(ve),i(D),H(()=>k(Ee,`⚠️ Warning: ${e(U).length??""} duplicate chapter${e(U).length===1?"":"s"} detected`)),f(R,D)};T(we,R=>{e(U).length>0&&R(ke)})}var ze=o(we,2),We=o(r(ze),2);qe(We,21,()=>e(C),Ue,(R,D,oe)=>{Fa(R,{index:oe,get chapter(){return e(D)}})}),i(We),i(ze);var u=o(ze,2);u.__click=w;var N=r(u);i(u),i(x),H(()=>{k(X,`Found ${e(C).length??""} chapter${e(C).length===1?"":"s"} from deepest folders`),u.disabled=!e(A)||!t.seriesId||e(Y).length===0,k(N,`Start Upload (${e(Y).length??""} of ${e(C).length??""} chapters)`)}),f(h,x)},_=h=>{var x=Te(),E=Se(x);{var j=B=>{Lt(B,{onDone:v,get busy(){return e(S)},set busy(ee){l(S,ee,!0)}})},X=B=>{var ee=Te(),de=Se(ee);{var $=te=>{var pe=Ra();f(te,pe)};T(de,te=>{e(c)==="completed"&&te($)},!0)}f(B,ee)};T(E,B=>{e(c)==="uploading"?B(j):B(X,!1)},!0)}f(h,x)};T(g,h=>{e(c)==="ready"||e(c)==="series_lookup"?h(d):h(_,!1)},!0)}f(n,p)};T(Q,n=>{e(c)==="loading"||e(c)==="extracting"?n(ue):n(ce,!1)})}i(ie),H(()=>{_e(ie,1,`uno-hemz07 ${a()??""}`),k(ne,`Processing: ${s.zipFile.name??""}`)}),f(y,ie),Ge()}Me(["click"]);var Aa=b('<div class="uno-j48514"><p class="uno-5v04yw">No zip file selected. Use the tabs above to select a zip file to process.</p></div>'),La=b('<div class="uno-eeu1av"><!> <!></div>'),Oa=b('<div class="uno-pb4e2u"><div class="uno-k0pcvl"><h1 class="uno-kryzyj">Guided Zip Manga Uploader</h1> <div class="uno-skt2gn"><button type="button" class="uno-q7l7gr">Simple Mode</button> <!></div></div> <a target="_blank" class="uno-6zhxse">Tutorial & Docs</a> <!> <!></div>');function Xa(y,s){Re(s,!0);const a=new Bt;Je($t,a),Je(nt,new jt);let t=z(null);function I(){a.workflowStep=De.SELECTING_MANGA_FOLDERS}function c(){if(a.workflowStep=De.PROCESSING_MANGA,a.selectedZipFiles.length>0){const m=a.selectedZipFiles[0],P=a.zipFiles.findIndex(O=>O.file===m);P>=0&&(a.currentZipIndex=P,l(t,m,!0))}}function V(m){l(t,m,!0),a.setZipStatus(m,me.PROCESSING)}function C(){if(a.moveToNextZip()){const m=a.currentZip;m&&(l(t,m.file,!0),a.setZipStatus(m.file,me.PROCESSING))}else l(t,null)}const q=xe(()=>a.workflowStep!==De.PROCESSING_MANGA);var S=Oa(),F=r(S),L=o(r(F),2),re=r(L);re.__click=()=>Ut(at("/"));var se=o(re,2);Ot(se,{}),i(L),i(F);var U=o(F,2),Z=o(U,2);{var W=m=>{Vt(m,{})};T(Z,m=>{e(q)&&m(W)})}var K=o(Z,2);{var G=m=>{Yt(m,{get guidedState(){return a},onDone:I,class:"uno-zgouyr"})},M=m=>{var P=Te(),O=Se(P);{var v=A=>{ta(A,{get guidedState(){return a},onDone:c,class:"uno-l0uum8"})},w=A=>{var Y=Te(),ie=Se(Y);{var le=ne=>{var Q=La(),ue=r(Q);ua(ue,{get guidedState(){return a},onZipSelected:V,class:"uno-wgeun8"});var ce=o(ue,2);{var n=g=>{Ma(g,{get guidedState(){return a},get zipFile(){return e(t)},onProcessingComplete:C,class:"uno-wgeun8"})},p=g=>{var d=Aa();f(g,d)};T(ce,g=>{e(t)?g(n):g(p,!1)})}i(Q),f(ne,Q)};T(ie,ne=>{a.workflowStep===De.PROCESSING_MANGA&&ne(le)},!0)}f(A,Y)};T(O,A=>{a.workflowStep===De.SELECTING_MANGA_FOLDERS?A(v):A(w,!1)},!0)}f(m,P)};T(K,m=>{a.workflowStep===De.SELECTING_ROOT_FOLDER?m(G):m(M,!1)})}i(S),H(m=>Ye(U,"href",m),[()=>at("/docs")]),f(y,S),Ge()}Me(["click"]);export{Xa as component,Ya as universal};
